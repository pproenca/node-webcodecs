# Spec Analysis: 10.6-10.7

## Algorithms to Implement

### ImageTrackList Interface (10.6)

**Spec Section:** 10.6.1 Internal Slots, 10.6.2 Attributes

#### Internal Slots
1. **[[ready promise]]** - Promise that resolves when ImageTrackList is populated with ImageTracks
2. **[[track list]]** - The list of ImageTracks in this ImageTrackList
3. **[[selected index]]** - Index of selected track (-1 means no track selected, initial value is -1)

#### Attributes

**ready (readonly Promise<undefined>)**
1. Return the [[ready promise]]

**length (readonly unsigned long)**
1. Return the length of [[track list]]

**selectedIndex (readonly long)**
1. Return [[selected index]]

**selectedTrack (readonly ImageTrack | null)**
1. If [[selected index]] is -1, return null
2. Otherwise, return ImageTrack from [[track list]] at position [[selected index]]

**getter ImageTrack(unsigned long index)**
1. Return ImageTrack at index in [[track list]]
2. Return undefined if index >= length (implicit)

**Error Conditions (spec-mandated):**
- None explicitly defined for getters - they return undefined for out-of-bounds access

**Edge Cases (from spec):**
- [[selected index]] starts at -1 (no track selected)
- Access beyond length returns undefined
- ready Promise should resolve after tracks are populated
- NOTE: ImageTrack frameCount can receive updates until complete is true

---

### ImageTrack Interface (10.7)

**Spec Section:** 10.7.1 Internal Slots, 10.7.2 Attributes

#### Internal Slots
1. **[[ImageDecoder]]** - The ImageDecoder instance that constructed this ImageTrack
2. **[[ImageTrackList]]** - The ImageTrackList instance that lists this ImageTrack
3. **[[animated]]** - Whether track contains animated image with multiple frames
4. **[[frame count]]** - Number of frames in this track
5. **[[repetition count]]** - Number of times animation repeats
6. **[[selected]]** - Whether track is selected for decoding

#### Attributes

**animated (readonly boolean)**
1. Return [[animated]]
   - NOTE: Provides early indication frameCount will exceed 0 for streaming images

**frameCount (readonly unsigned long)**
1. Return [[frame count]]

**repetitionCount (readonly unrestricted float)**
1. Return [[repetition count]]
   - Infinity for infinite loop (GIF loop count = 0)
   - Number for finite repetitions

**selected (getter boolean)**
1. Return [[selected]]

**selected (setter)**
Algorithm Steps:
1. If [[ImageDecoder]]'s [[closed]] slot is true, abort these steps
2. Let newValue be the given value
3. If newValue equals [[selected]], abort these steps
4. Assign newValue to [[selected]]
5. Let parentTrackList be [[ImageTrackList]]
6. Let oldSelectedIndex be parentTrackList [[selected index]]
7. If oldSelectedIndex is not -1:
   a. Let oldSelectedTrack be ImageTrack at oldSelectedIndex in parentTrackList [[track list]]
   b. Assign false to oldSelectedTrack [[selected]]
8. If newValue is true, let selectedIndex be index of this ImageTrack in parentTrackList. Otherwise, let selectedIndex be -1
9. Assign selectedIndex to parentTrackList [[selected index]]
10. Run Reset ImageDecoder algorithm on [[ImageDecoder]]
11. Queue control message to update internal selected track index with selectedIndex
12. Process the control message queue

**Error Conditions (spec-mandated):**
- Setting selected on closed decoder: No explicit error thrown, just aborts

**Edge Cases (from spec):**
- Setting selected to same value is a no-op (step 3)
- Setting selected to true when already another track selected deselects the old track
- Setting selected to false sets selectedIndex to -1
- Closed decoder causes setter to silently abort

---

## Inputs NOT in Test Requirements (Must Still Work)

### ImageTrackList
- Empty track list (length = 0)
- Track list with multiple tracks
- Iteration via Symbol.iterator
- Calling selectedTrack when no track is selected (returns null)

### ImageTrack
- animated = true with frameCount = 1 (single-frame "animated" GIF)
- repetitionCount = 0 (play once, don't repeat)
- repetitionCount = Infinity (loop forever)
- Finite positive repetitionCount values
- Deselecting a track (selected = false)
- Re-selecting the same track (no-op per step 3)

---

## Current Implementation Analysis

### ImageTrackList (lib/image-track-list.ts)
- ✅ Has [[track list]] via _tracks
- ✅ Has [[ready promise]] via _ready
- ⚠️ [[selected index]] computed dynamically by scanning tracks - should be stored
- ✅ ready getter
- ✅ length getter
- ⚠️ selectedIndex iterates tracks instead of returning stored value
- ✅ selectedTrack returns null for -1, otherwise returns track
- ✅ Index accessor via Object.defineProperty
- ✅ Symbol.iterator for iteration
- ✅ _updateTracks internal method

### ImageTrack (lib/image-track.ts)
- ⚠️ Missing [[ImageDecoder]] internal slot
- ⚠️ Missing [[ImageTrackList]] internal slot
- ✅ Has [[animated]] via _animated
- ✅ Has [[frame count]] via _frameCount
- ✅ Has [[repetition count]] via _repetitionCount
- ✅ Has [[selected]] via _selected
- ✅ animated getter
- ✅ frameCount getter
- ✅ repetitionCount getter
- ✅ selected getter
- ⚠️ selected setter missing spec algorithm (doesn't deselect other tracks, doesn't update parent list)

---

## Required Changes

### ImageTrackList
1. Store [[selected index]] directly instead of computing
2. Add method to update [[selected index]] when track selection changes

### ImageTrack
1. Add [[ImageDecoder]] reference
2. Add [[ImageTrackList]] reference
3. Implement full selected setter algorithm per spec 10.7.2
