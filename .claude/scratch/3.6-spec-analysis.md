# Spec Analysis: 3.6

## Algorithms to Test

### Schedule Dequeue Event
**Spec Section:** 3.6
**Steps:**
1. If [[dequeue event scheduled]] is true, return
2. Set [[dequeue event scheduled]] to true
3. Queue task to fire dequeue event and reset flag

**Tests Needed:**
- Dequeue events are coalesced (not spammed) - PARTIALLY COVERED (events.test.ts)
- Multiple outputs in batch fire single dequeue - NEEDS TEST

### Output AudioData
**Spec Section:** 3.6
**Steps:**
1. For each output, create AudioData
2. Invoke [[output callback]] with data

**Tests Needed:**
- Output callback invoked for each decoded frame - COVERED (golden)
- Output callback throws but decoder continues - COVERED (events.test.ts concept)

### Reset AudioDecoder
**Spec Section:** 3.6
**Steps:**
1. If [[state]] is "closed", throw InvalidStateError
2. Set [[state]] to "unconfigured"
3. Signal codec to cease producing output
4. Remove all control messages from queue
5. If decodeQueueSize > 0, set to 0 and schedule dequeue
6. For each pending flush promise, reject with exception

**Tests Needed:**
- Reset changes state to "unconfigured" - COVERED (golden, contracts, methods)
- Reset clears decodeQueueSize - COVERED (methods test)
- Reset rejects pending flush promises with AbortError - NEEDS TEST
- Reset when already unconfigured is no-op - NEEDS TEST
- Reset when closed is no-op per current impl - COVERED (golden)

### Close AudioDecoder
**Spec Section:** 3.6
**Steps:**
1. Run Reset AudioDecoder with exception
2. Set [[state]] to "closed"
3. Clear codec implementation and release resources
4. If exception is not AbortError, invoke error callback

**Tests Needed:**
- Close changes state to "closed" - COVERED (contracts)
- Close rejects pending flush promises - NEEDS TEST
- Close when already closed is idempotent - NEEDS TEST
- Close releases native resources - verified by lack of leaks

## Gap Analysis

Most tests exist. Need to add:
1. Reset/close rejecting pending flush promises
2. Dequeue coalescing verification
3. Close when already closed
4. Reset when already unconfigured
