# Spec Analysis: 3.1 (AudioDecoder Internal Slots)

## Internal Slots from Spec

| Slot | Spec Initial Value | Implementation | Location |
|------|-------------------|----------------|----------|
| [[control message queue]] | new queue | `_controlQueue: ControlMessageQueue` | audio-decoder.ts:21 |
| [[message queue blocked]] | false | Not explicit (in ControlMessageQueue) | control-message-queue.ts |
| [[codec implementation]] | null | `_native: NativeAudioDecoder` | audio-decoder.ts:20 |
| [[codec work queue]] | new parallel queue | AsyncDecodeWorker in C++ | native layer |
| [[codec saturated]] | false | native.codecSaturated | native layer |
| [[output callback]] | init.output | Stored in native | audio-decoder.ts:32-43 |
| [[error callback]] | init.error | `_errorCallback` | audio-decoder.ts:24 |
| [[key chunk required]] | true | `_needsKeyFrame: boolean = true` | audio-decoder.ts:23 |
| [[state]] | "unconfigured" | native.state | native layer |
| [[decodeQueueSize]] | 0 | `_decodeQueueSize: number = 0` | audio-decoder.ts:22 |
| [[pending flush promises]] | new list | In native flush() | native layer |
| [[dequeue event scheduled]] | false | In CodecBase._triggerDequeue | codec-base.ts |

## Constructor Steps Verification (Spec 3.2)

| Step | Spec Requirement | Implementation | Status |
|------|------------------|----------------|--------|
| 1 | Create new AudioDecoder | `constructor` | OK |
| 2 | Assign new queue to [[control message queue]] | `this._controlQueue = new ControlMessageQueue()` | OK |
| 3 | Assign false to [[message queue blocked]] | Queue initializes with `processing: false` | OK |
| 4 | Assign null to [[codec implementation]] | `this._native` created, starts unconfigured | OK |
| 5 | Assign new parallel queue | AsyncWorker in native | OK |
| 6 | Assign false to [[codec saturated]] | Native starts unsaturated | OK |
| 7 | Assign init.output to [[output callback]] | Passed to native constructor | OK |
| 8 | Assign init.error to [[error callback]] | `this._errorCallback = init.error` | OK |
| 9 | Assign true to [[key chunk required]] | `_needsKeyFrame: boolean = true` | OK |
| 10 | Assign "unconfigured" to [[state]] | Native starts unconfigured | OK |
| 11 | Assign 0 to [[decodeQueueSize]] | `_decodeQueueSize: number = 0` | OK |
| 12 | Assign new list to [[pending flush promises]] | Native handles | OK |
| 13 | Assign false to [[dequeue event scheduled]] | CodecBase handles | OK |

## Missing Callback Validation

The current constructor doesn't validate that `init.output` and `init.error` are functions.
Need to add `is.assertFunction()` calls per spec.

## Test Requirements

### Unit Tests Required
1. Constructor initializes state to "unconfigured"
2. Constructor initializes decodeQueueSize to 0
3. Constructor stores output callback (verified by output working)
4. Constructor stores error callback (verified by error callback being invoked)
5. Key chunk required is true after construction (verified by decode() rejecting delta frames)

### Edge Cases to Test
1. Multiple AudioDecoder instances have independent state
2. Constructor with minimal valid init

### Error Cases to Test
1. Constructor with missing output callback → TypeError
2. Constructor with missing error callback → TypeError
3. Constructor with non-function output → TypeError
4. Constructor with non-function error → TypeError

## Implementation Gap

The constructor needs to validate callbacks:
```typescript
constructor(init: AudioDecoderInit) {
  super();
  is.assertPlainObject(init, 'init');
  is.assertFunction(init.output, 'init.output');
  is.assertFunction(init.error, 'init.error');
  // ...
}
```

Currently, it doesn't check that init.output and init.error are functions.
