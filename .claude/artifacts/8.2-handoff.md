# 8.2 Handoff: EncodedVideoChunk Interface

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Requirement | Implementation | Test |
|--------------|-------------|----------------|------|
| 8.2.1 | Internal slots: type, timestamp, duration, data | Private _native holds state | attribute tests |
| 8.2.2 | Constructor with EncodedVideoChunkInit | lib/encoded-chunks.ts:70-100 | constructor tests (8) |
| 8.2.3 | type attribute ("key"\|"delta") | getter returns _native.type | type tests |
| 8.2.3 | timestamp attribute (microseconds) | getter returns _native.timestamp | timestamp tests |
| 8.2.3 | duration attribute (nullable) | getter returns _native.duration ?? null | duration tests |
| 8.2.3 | byteLength attribute | getter returns _native.byteLength | byteLength test |
| 8.2.4 | copyTo(destination) method | lib/encoded-chunks.ts:118-129 | copyTo tests (4) |
| 8.2.5 | close() for early release | lib/encoded-chunks.ts:136-139 | close tests (2) |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| 8.2.2 Constructor | 8 | YES |
| 8.2.3 Attributes | 6 | YES |
| 8.2.4 copyTo Method | 4 | YES |
| Key/delta frame semantics | 3 | YES |
| Edge cases | 4 | YES |
| Type exports | 3 | YES |
| close() method | 2 | YES |
| **Total** | **30** | **YES** |

## Tests Added

`test/unit/encoded-video-chunk.test.ts`:

**8.2.2 Constructor:**
- should construct with valid init
- should accept type: "key"
- should accept type: "delta"
- should accept ArrayBuffer as data
- should accept Uint8Array as data
- should accept optional duration
- should throw TypeError for invalid type
- should throw TypeError for missing data

**8.2.3 Attributes:**
- should have readonly type attribute
- should have readonly timestamp attribute in microseconds
- should support negative timestamp
- should have nullable duration attribute
- should have duration when provided
- should have byteLength matching data size

**8.2.4 copyTo Method:**
- should copy data to ArrayBuffer destination
- should copy data to Uint8Array destination
- should copy data to larger destination
- should throw if destination is too small

**Key and delta frame semantics:**
- should mark key frames with type "key"
- should mark delta frames with type "delta"
- should support GOP structure (key followed by deltas)

**Edge cases:**
- should handle zero-length data
- should handle large data (>1MB for 4K)
- should preserve microsecond timestamp precision
- should distinguish duration = 0 vs null (implementation-specific)

**Type exports:**
- should export EncodedVideoChunk class
- should export EncodedVideoChunkType type
- should export EncodedVideoChunkInit type

**close() method:**
- should have close method
- should allow double close without error

## Implementation Notes

EncodedVideoChunk is correctly implemented in lib/encoded-chunks.ts:

- Constructor validates type ("key"|"delta") and data
- Accepts ArrayBuffer or ArrayBufferView for data
- FinalizationRegistry provides automatic cleanup if close() not called
- close() is idempotent (safe to call multiple times)
- Key frames (type="key") are independently decodable (I-frames)
- Delta frames (type="delta") require previous frames (P/B-frames)

**Known gap:** duration=0 converts to null due to `?? null` operator. Per W3C spec, 0 should be a valid duration distinct from null.

## Files Modified

- `test/unit/encoded-video-chunk.test.ts`: New test file with 30 tests

## Downstream Unblocked

- TODO-4.x: VideoEncoder outputs EncodedVideoChunk
- TODO-6.x: VideoDecoder inputs EncodedVideoChunk
