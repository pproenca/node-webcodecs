# 3.1 Handoff: AudioDecoder Internal Slots

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Slot | Implementation | Location | Test |
|--------------|------|----------------|----------|------|
| 3.1 | [[control message queue]] | `_controlQueue: ControlMessageQueue` | audio-decoder.ts:21 | reset behavior |
| 3.1 | [[message queue blocked]] | In ControlMessageQueue.processing | control-message-queue.ts | - |
| 3.1 | [[codec implementation]] | `_native: NativeAudioDecoder` | audio-decoder.ts:20 | - |
| 3.1 | [[codec work queue]] | AsyncDecodeWorker | native layer | - |
| 3.1 | [[codec saturated]] | native.codecSaturated | native layer | - |
| 3.1 | [[output callback]] | init.output | audio-decoder.ts:37-48 | output invocation |
| 3.1 | [[error callback]] | `_errorCallback` | audio-decoder.ts:24 | error invocation |
| 3.1 | [[key chunk required]] | `_needsKeyFrame: boolean = true` | audio-decoder.ts:23 | key chunk required |
| 3.1 | [[state]] | native.state | native layer | state init |
| 3.1 | [[decodeQueueSize]] | `_decodeQueueSize: number = 0` | audio-decoder.ts:22 | decodeQueueSize init |
| 3.1 | [[pending flush promises]] | In native flush() | native layer | - |
| 3.1 | [[dequeue event scheduled]] | In CodecBase._triggerDequeue | codec-base.ts | - |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| Constructor initialization | 6 | YES |
| Callback validation | 4 | YES |
| Independent instances | 2 | YES |
| Key chunk required reset | 1 | YES |
| **Total** | **13** | **YES** |

## Constructor Steps (3.2) Verified

| Step | Requirement | Status |
|------|-------------|--------|
| 1 | Create new AudioDecoder | OK |
| 2 | Assign new queue to [[control message queue]] | OK |
| 3 | Assign false to [[message queue blocked]] | OK |
| 4 | Assign null to [[codec implementation]] | OK (unconfigured) |
| 5 | Assign new parallel queue to [[codec work queue]] | OK (native) |
| 6 | Assign false to [[codec saturated]] | OK (native) |
| 7 | Assign init.output to [[output callback]] | OK |
| 8 | Assign init.error to [[error callback]] | OK |
| 9 | Assign true to [[key chunk required]] | OK |
| 10 | Assign "unconfigured" to [[state]] | OK |
| 11 | Assign 0 to [[decodeQueueSize]] | OK |
| 12 | Assign new list to [[pending flush promises]] | OK (native) |
| 13 | Assign false to [[dequeue event scheduled]] | OK (base class) |

## Files Modified

- `lib/audio-decoder.ts`: Added callback validation in constructor
  - Added `is.assertPlainObject(init, 'init')`
  - Added `is.assertFunction(init.output, 'init.output')`
  - Added `is.assertFunction(init.error, 'init.error')`

- `test/unit/audio-decoder-slots.test.ts`: New test file with 13 tests

## Implementation Fix

Added proper callback validation per W3C spec. Previously, missing callbacks were detected by the native layer with generic errors. Now TypeScript layer validates with proper TypeErrors:

```typescript
constructor(init: AudioDecoderInit) {
  super();
  // W3C spec: output and error callbacks are required
  is.assertPlainObject(init, 'init');
  is.assertFunction(init.output, 'init.output');
  is.assertFunction(init.error, 'init.error');
  // ...
}
```

## Downstream Unblocked

- TODO-3.2: Constructor depends on slots (verified)
- TODO-3.5: Methods depend on slots
