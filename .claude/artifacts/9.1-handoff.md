# 9.1 Handoff: Memory Model

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Requirement | Implementation | Test |
|--------------|-------------|----------------|------|
| 9.1.1 | Background - explicit resource release | close() method | 2 tests |
| 9.1.2 | close() marks object as closed | VideoFrame/AudioData._closed flag | 2 tests |
| 9.1.2 | Attributes return defaults after close | Getter checks _closed | 2 tests |
| 9.1.2 | clone() creates new object | VideoFrame/AudioData.clone() | 2 tests |
| 9.1.2 | clone() shares same resource | clone() calls native clone | 2 tests |
| 9.1.2 | close() original doesn't affect clone | Reference counting in native | 2 tests |
| 9.1.2 | close() clone doesn't affect original | Reference counting in native | 2 tests |
| 9.1.2 | close() is idempotent | Guard check in close() | 2 tests |
| 9.1.2 | clone() throws on closed â†’ InvalidStateError | Guard check in clone() | 2 tests |
| 9.1.3 | Transfer detaches ArrayBuffer | transfer option + detachArrayBuffers | 2 tests |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| 9.1.1 Background | 2 | YES |
| 9.1.2 VideoFrame Reference Counting | 7 | YES |
| 9.1.2 AudioData Reference Counting | 7 | YES |
| Edge cases - clone chain | 4 | YES |
| Error cases - use after close | 4 | YES |
| Attribute behavior after close | 2 | YES |
| 9.1.3 Transfer semantics | 2 | YES |
| VideoFrame-from-VideoFrame | 3 | YES |
| **Total** | **31** | **YES** |

## Tests Added

`test/unit/memory-model.test.ts`:

**9.1.1 Background:**
- should support explicit resource release via close()
- should support explicit resource release for AudioData via close()

**9.1.2 Reference Counting - VideoFrame:**
- should mark VideoFrame as closed after close()
- should create new VideoFrame via clone()
- should share media resource between VideoFrame and clone
- should not affect clone when original VideoFrame is closed
- should not affect original when clone is closed
- should throw InvalidStateError when cloning closed VideoFrame
- should allow double close() on VideoFrame without error

**9.1.2 Reference Counting - AudioData:**
- should mark AudioData as closed after close()
- should create new AudioData via clone()
- should share media resource between AudioData and clone
- should not affect clone when original AudioData is closed
- should not affect original when clone is closed
- should throw InvalidStateError when cloning closed AudioData
- should allow double close() on AudioData without error

**Edge cases - clone chain:**
- should support clone of clone for VideoFrame
- should support clone of clone for AudioData
- should support closing VideoFrame clones in any order
- should support closing AudioData clones in any order

**Error cases - use after close:**
- should throw InvalidStateError for copyTo after VideoFrame close
- should throw InvalidStateError for allocationSize after VideoFrame close
- should throw InvalidStateError for copyTo after AudioData close
- should throw InvalidStateError for allocationSize after AudioData close

**Attribute behavior after close:**
- should return default values for VideoFrame attributes after close
- should return default values for AudioData attributes after close

**9.1.3 Transfer semantics:**
- should detach transferred ArrayBuffer when constructing VideoFrame
- should detach transferred ArrayBuffer when constructing AudioData

**VideoFrame-from-VideoFrame construction:**
- should construct VideoFrame from existing VideoFrame
- should allow timestamp override when constructing from VideoFrame
- should throw InvalidStateError when constructing from closed VideoFrame

## Implementation Notes

Memory model is correctly implemented:

**VideoFrame (lib/video-frame.ts):**
- `_closed` flag tracks closure state
- `close()` calls native close and sets flag (idempotent)
- `clone()` calls native clone, creates wrapper with shared resource
- All getters check `_closed` and return defaults (0, null) if closed
- Methods throw `InvalidStateError` if called on closed frame

**AudioData (lib/audio-data.ts):**
- Same pattern as VideoFrame
- `_closed` flag, idempotent `close()`
- `clone()` shares resource via native clone
- Getters return 0/null when closed

**Transfer (lib/transfer.ts):**
- `detachArrayBuffers()` transfers ownership of ArrayBuffers
- Used by VideoFrame and AudioData constructors with `transfer` option

**Native layer:**
- Reference counting implemented at C++ level
- Resource stays alive while any clone/reference exists
- Resources freed when last reference closed

## Files Modified

- `test/unit/memory-model.test.ts`: New test file with 31 tests
- `.claude/scratch/9.1-spec-analysis.md`: Spec analysis document

## Downstream Unblocked

- TODO-9.2: AudioData interface (uses Memory Model)
- TODO-9.4: VideoFrame interface (uses Memory Model)
