# 5.6 Handoff: AudioEncoder Algorithms

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Algorithm | Implementation | Test |
|--------------|-----------|----------------|------|
| 5.6 Schedule Dequeue Event | Coalesce events via [[dequeue event scheduled]] | codec-base.ts:28-40 | coalesce test |
| 5.6 Output EncodedAudioChunks | Create EncodedAudioChunk, invoke [[output callback]] | audio-encoder.ts:43-53 | output tests |
| 5.6 Reset AudioEncoder | Set state to unconfigured, clear queue | audio-encoder.ts:142-151 | reset tests |
| 5.6 Close AudioEncoder | Run Reset, set state to closed | audio-encoder.ts:153-156 | close tests |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| Reset AudioEncoder algorithm | 5 | YES |
| Close AudioEncoder algorithm | 3 | YES |
| Output EncodedAudioChunks algorithm | 4 | YES |
| Schedule Dequeue Event algorithm | 2 | YES |
| **Total** | **14** | **YES** |

## Tests Added

`test/unit/audio-encoder-algorithms.test.ts`:

**Reset AudioEncoder algorithm:**
- should set state to "unconfigured"
- should clear encodeQueueSize to 0
- should reject pending flush promise with AbortError on reset
- should be a no-op when already closed
- should be safe when already unconfigured

**Close AudioEncoder algorithm:**
- should set state to "closed"
- should reject pending flush promise with AbortError on close
- should be idempotent (safe to call multiple times)

**Output EncodedAudioChunks algorithm:**
- should invoke output callback for each encoded chunk
- should output EncodedAudioChunk with timestamp
- should output EncodedAudioChunk with type
- should invoke output callback with EncodedAudioChunk

**Schedule Dequeue Event algorithm:**
- should coalesce rapid dequeue events
- should fire dequeue event when encodeQueueSize decreases

## Implementation Notes

The implementation was already complete:
- Reset algorithm: Sets state to unconfigured, clears queue, clears encodeQueueSize
- Close algorithm: Runs reset then sets state to closed, releases resources
- Output algorithm: Creates EncodedAudioChunk wrapper with native data, invokes callback
- Dequeue algorithm: Uses CodecBase._triggerDequeue() which dispatches Event

Note: Unlike VideoEncoder, AudioEncoder doesn't currently provide metadata.decoderConfig
in the output callback. This is a gap in the native implementation.

## Files Modified

- `test/unit/audio-encoder-algorithms.test.ts`: New test file with 14 tests

## Downstream Unblocked

- TODO-5.7: EncodedAudioChunkMetadata
