# 4.6 Handoff: VideoDecoder Algorithms

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Algorithm | Implementation | Test |
|--------------|-----------|----------------|------|
| 4.6 Schedule Dequeue Event | Coalesce events via [[dequeue event scheduled]] | codec-base.ts:28-40 | coalesce test |
| 4.6 Output VideoFrames | Create VideoFrame, invoke [[output callback]] | video-decoder.ts:46-59 | output tests |
| 4.6 Reset VideoDecoder | Set state to unconfigured, reject pending | video-decoder.ts:199-209 | reset tests |
| 4.6 Close VideoDecoder | Run Reset, set state to closed | video-decoder.ts:211-215 | close tests |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| Reset VideoDecoder algorithm | 5 | YES |
| Close VideoDecoder algorithm | 3 | YES |
| Output VideoFrames algorithm | 3 | YES |
| Schedule Dequeue Event algorithm | 2 | YES |
| **Total** | **13** | **YES** |

## Tests Added

`test/unit/video-decoder-algorithms.test.ts`:

**Reset VideoDecoder algorithm:**
- should set state to "unconfigured"
- should clear decodeQueueSize to 0
- should reject pending flush promise with AbortError on reset
- should throw InvalidStateError when already closed
- should be safe when already unconfigured

**Close VideoDecoder algorithm:**
- should set state to "closed"
- should reject pending flush promise with AbortError on close
- should be idempotent (safe to call multiple times)

**Output VideoFrames algorithm:**
- should invoke output callback for each decoded frame
- should output VideoFrame with timestamp
- should output VideoFrame with correct dimensions

**Schedule Dequeue Event algorithm:**
- should coalesce rapid dequeue events
- should fire dequeue event when decodeQueueSize decreases

## Implementation Notes

The implementation was already complete:
- Reset algorithm: Sets state to unconfigured, clears queue, clears decodeQueueSize
- Close algorithm: Runs reset then sets state to closed, releases resources
- Output algorithm: Creates VideoFrame wrapper with native data, invokes callback
- Dequeue algorithm: Uses CodecBase._triggerDequeue() which dispatches Event

## Files Modified

- `test/unit/video-decoder-algorithms.test.ts`: New test file with 13 tests

## Downstream Unblocked

- None (algorithms are internal)
