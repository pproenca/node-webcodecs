# 6.1 Handoff: VideoEncoder Internal Slots

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Slot | Implementation | Test |
|--------------|------|----------------|------|
| 6.1 | [[control message queue]] | _controlQueue: ControlMessageQueue | reset behavior test |
| 6.1 | [[message queue blocked]] | In ControlMessageQueue.processing | - |
| 6.1 | [[codec implementation]] | _native: NativeVideoEncoder | state tests |
| 6.1 | [[codec work queue]] | AsyncEncodeWorker | - |
| 6.1 | [[codec saturated]] | native.codecSaturated | saturated tests |
| 6.1 | [[output callback]] | init.output | output EncodedVideoChunk test |
| 6.1 | [[error callback]] | init.error | error callback test |
| 6.1 | [[active encoder config]] | In native layer | configure tests |
| 6.1 | [[active output config]] | In native layer (via metadata) | - |
| 6.1 | [[state]] | native.state | state tests |
| 6.1 | [[encodeQueueSize]] | _encodeQueueSize: number | queue tests |
| 6.1 | [[pending flush promises]] | In native flush() | - |
| 6.1 | [[dequeue event scheduled]] | In CodecBase | - |
| 6.1 | [[active orientation]] | Tracked in native layer | - |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| Constructor initialization | 5 | YES |
| Callback validation | 4 | YES |
| Output receives EncodedVideoChunk | 1 | YES |
| Independent instances | 2 | YES |
| [[active encoder config]] slot | 3 | YES |
| [[codec saturated]] slot | 2 | YES |
| maxQueueDepth (backpressure) | 3 | YES |
| ready Promise (backpressure) | 1 | YES |
| **Total** | **21** | **YES** |

## Tests Added

`test/unit/video-encoder-slots.test.ts`:

**Constructor initialization:**
- should initialize state to "unconfigured"
- should initialize encodeQueueSize to 0
- should store output callback (verified via encoder creation)
- should store error callback (verified via encoder creation)
- should have control message queue (verified via reset behavior)

**Callback validation:**
- should throw TypeError when output callback is missing
- should throw TypeError when error callback is missing
- should throw TypeError when output is not a function
- should throw TypeError when error is not a function

**Output callback:**
- should output EncodedVideoChunk objects

**Independent instances:**
- should maintain independent state for multiple encoders
- should maintain independent encodeQueueSize

**[[active encoder config]] slot:**
- should be null before configure (inferred from state)
- should be set after configure
- should update on reconfigure

**[[codec saturated]] slot:**
- should be false initially
- should be accessible after configure

**maxQueueDepth (backpressure):**
- should have default maxQueueDepth of 16
- should allow setting maxQueueDepth
- should throw RangeError for maxQueueDepth < 1

**ready Promise (backpressure):**
- should resolve immediately when queue is empty

## Implementation Notes

The implementation was already complete with callback validation.
Key encoder-specific slots:
- [[encodeQueueSize]] for tracking pending encodes
- [[active encoder config]] for the configured settings
- [[active output config]] provided via metadata with each output
- [[active orientation]] tracked for video frame orientation

Additional VideoEncoder-specific features:
- maxQueueDepth for backpressure control
- ready Promise for async backpressure handling
- codecSaturated getter for saturation state

## Files Modified

- `test/unit/video-encoder-slots.test.ts`: New test file with 21 tests

## Downstream Unblocked

- TODO-6.2: Constructor
- TODO-6.5: Methods
