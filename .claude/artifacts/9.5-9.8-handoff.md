# 9.5-9.8 Handoff: VideoFrame CopyTo, DOMRects, PlaneLayout, PixelFormat

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Requirement | Implementation | Test |
|--------------|-------------|----------------|------|
| 9.5 | VideoFrameCopyToOptions.rect | lib/video-frame.ts:321-337 | copyTo with rect tests |
| 9.5 | VideoFrameCopyToOptions.layout | native layer | PlaneLayout tests |
| 9.5 | VideoFrameCopyToOptions.format | lib/video-frame.ts:391 | format conversion test |
| 9.5 | VideoFrameCopyToOptions.colorSpace | defaults to srgb | colorSpace test |
| 9.6 | codedRect computed | lib/video-frame.ts:253-268 | codedRect tests |
| 9.6 | visibleRect defaults to full frame | lib/video-frame.ts:270-287 | visibleRect tests |
| 9.7 | PlaneLayout.offset | native layer returns | offset property test |
| 9.7 | PlaneLayout.stride | native layer returns | stride property test |
| 9.8 | All 23+ VideoPixelFormat values | lib/types.ts:167-202 | format enumeration tests |
| 9.8 | I420 (3 planes) | native layer | plane count test |
| 9.8 | I420A (4 planes) | native layer | plane count test |
| 9.8 | NV12 (2 planes) | native layer | plane count test |
| 9.8 | RGBA (1 plane) | native layer | plane count test |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| 9.5 VideoFrameCopyToOptions | 5 | YES |
| 9.6 DOMRects | 4 | YES |
| 9.7 PlaneLayout | 4 | YES |
| 9.8 VideoPixelFormat | 16 | YES |
| Type exports | 3 | YES |
| **Total** | **32** | **YES** |

## Tests Added

`test/unit/videoframe-copyto-pixelformat.test.ts`:

**9.5 VideoFrameCopyToOptions:**
- should copy full visibleRect when no options provided
- should copy subset when rect option provided
- should throw RangeError for rect exceeding dimensions
- should support copyTo with different output format
- should default colorSpace to srgb

**9.6 DOMRects in VideoFrame:**
- should have codedRect matching coded dimensions
- should have visibleRect defaulting to full frame
- should return null for codedRect after close
- should return null for visibleRect after close

**9.7 PlaneLayout:**
- should return PlaneLayout array from copyTo
- should have offset and stride in PlaneLayout
- should have stride >= width for packed formats
- should return multiple PlaneLayouts for planar formats

**9.8 VideoPixelFormat:**
- should support all 23 base VideoPixelFormat values
- Packed RGB formats: RGBA, RGBX, BGRA, BGRX (1 plane each)
- 4:2:0 YUV: I420 with 3 planes
- 4:2:0 YUVA: I420A with 4 planes
- Semi-planar: NV12 with 2 planes
- Allocation size for RGBA, I420, NV12
- Odd-width/height handling for 4:2:0 formats

**Type exports:**
- should export PlaneLayout interface
- should export VideoFrameCopyToOptions interface
- should export VideoPixelFormat type

## Implementation Notes

### VideoFrameCopyToOptions (9.5)
- rect: Specifies subset of frame to copy (defaults to visibleRect)
- layout: Custom PlaneLayout for each plane
- format: Target format for conversion (RGBA, RGBX, BGRA, BGRX)
- colorSpace: Target color space (srgb, display-p3)

### DOMRects (9.6)
- codedRect: Full coded dimensions (x=0, y=0, width=codedWidth, height=codedHeight)
- visibleRect: Visible portion (may be cropped)
- Pixels are integer-addressable (floats truncated)

### PlaneLayout (9.7)
- offset: Byte offset in buffer where plane begins
- stride: Bytes per row (including padding)
- copyTo returns PlaneLayout[] describing output

### VideoPixelFormat (9.8)
All 23+ formats defined in lib/types.ts:

| Format Family | Variants | Planes | Description |
|---------------|----------|--------|-------------|
| I420 | I420, I420P10, I420P12 | 3 | 4:2:0 YUV planar |
| I420A | I420A, I420AP10, I420AP12 | 4 | 4:2:0 YUVA planar |
| I422 | I422, I422P10, I422P12 | 3 | 4:2:2 YUV planar |
| I422A | I422A, I422AP10, I422AP12 | 4 | 4:2:2 YUVA planar |
| I444 | I444, I444P10, I444P12 | 3 | 4:4:4 YUV planar |
| I444A | I444A, I444AP10, I444AP12 | 4 | 4:4:4 YUVA planar |
| NV12 | NV12, NV12A, NV21, NV12P10 | 2-3 | Semi-planar |
| RGB | RGBA, RGBX, BGRA, BGRX | 1 | Packed RGBA |

## Files Modified

- `test/unit/videoframe-copyto-pixelformat.test.ts`: New test file with 32 tests

## Downstream Unblocked

- VideoFrame is fully tested for copy operations
- Pixel format conversions verified
