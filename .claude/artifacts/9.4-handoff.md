# 9.4 Handoff: VideoFrame Interface

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Requirement | Implementation | Test |
|--------------|-------------|----------------|------|
| 9.4.1 | Internal slots | Private _native/_closed | attribute tests |
| 9.4.2 | Constructor with buffer | lib/video-frame.ts:172-200 | constructor tests (8) |
| 9.4.2 | Constructor from VideoFrame | lib/video-frame.ts:123-170 | VideoFrame-from-VideoFrame tests |
| 9.4.2 | format is required | lib/video-frame.ts:177-179 | should require format |
| 9.4.3 | format attribute (nullable) | getter returns null if closed | format tests (3) |
| 9.4.3 | codedWidth/codedHeight | getter returns _native values | dimension tests |
| 9.4.3 | codedRect | computed from codedWidth/Height | codedRect tests |
| 9.4.3 | visibleRect | defaults to full frame | visibleRect tests |
| 9.4.3 | displayWidth/displayHeight | getter returns _native values | display dimension tests |
| 9.4.3 | timestamp | getter returns _native.timestamp | timestamp tests (2) |
| 9.4.3 | duration (nullable) | returns null if not provided | duration tests |
| 9.4.3 | colorSpace | VideoColorSpace instance | colorSpace tests |
| 9.4.3 | rotation | defaults to 0 | rotation tests |
| 9.4.3 | flip | defaults to false | flip tests |
| 9.4.5 | allocationSize(options) | lib/video-frame.ts:395-422 | allocationSize tests (3) |
| 9.4.5 | copyTo(destination, options) | lib/video-frame.ts:317-393 | copyTo tests (4) |
| 9.4.5 | clone() | lib/video-frame.ts:555-573 | clone tests (3) |
| 9.4.5 | close() | lib/video-frame.ts:310-315 | close tests (3) |
| 9.4.5 | metadata() | lib/video-frame.ts:302-308 | metadata tests (2) |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| 9.4.2 Constructor | 8 | YES |
| 9.4.3 Attributes | 13 | YES |
| 9.4.5 allocationSize | 3 | YES |
| 9.4.5 copyTo | 4 | YES |
| 9.4.5 clone | 3 | YES |
| 9.4.5 close | 3 | YES |
| 9.4.5 metadata | 2 | YES |
| Edge cases | 3 | YES |
| Type exports | 2 | YES |
| **Total** | **41** | **YES** |

## Tests Added

`test/unit/video-frame.test.ts`:

**9.4.2 Constructor:**
- should construct with valid buffer and init
- should accept ArrayBuffer as data
- should accept Uint8Array as data
- should require timestamp
- should accept optional duration
- should require format for buffer constructor
- should construct from existing VideoFrame
- should allow timestamp override when constructing from VideoFrame

**9.4.3 Attributes:**
- should have format attribute
- should support I420 format
- should support NV12 format
- should have codedWidth and codedHeight
- should have codedRect matching dimensions
- should have visibleRect defaulting to full frame
- should have displayWidth and displayHeight
- should have timestamp in microseconds
- should support negative timestamp
- should have null duration when not provided
- should have colorSpace attribute
- should have rotation attribute defaulting to 0
- should have flip attribute defaulting to false

**9.4.5 allocationSize Method:**
- should return correct allocation size for RGBA format
- should return correct allocation size for I420 format
- should throw InvalidStateError if called after close

**9.4.5 copyTo Method:**
- should copy pixel data to destination
- should return PlaneLayout array from copyTo
- should reject if called after close
- should throw if destination buffer too small

**9.4.5 clone Method:**
- should create new VideoFrame via clone
- should share pixel data between original and clone
- should throw InvalidStateError when cloning closed VideoFrame

**9.4.5 close Method:**
- should mark VideoFrame as closed
- should allow double close without error
- should return default values after close

**9.4.5 metadata Method:**
- should return metadata object
- should throw InvalidStateError if called after close

**Edge cases:**
- should handle 4K resolution frames
- should handle 1x1 pixel frame
- should preserve microsecond timestamp precision

**Type exports:**
- should export VideoFrame class
- should export VideoColorSpace class

## Implementation Notes

VideoFrame is correctly implemented in lib/video-frame.ts:

**Constructor (9.4.2):**
- Accepts Buffer, ArrayBuffer, or Uint8Array
- Validates format is required
- Supports VideoFrame-from-VideoFrame construction with overrides
- Supports ImageData construction (canvas compatibility)
- Handles ArrayBuffer transfer semantics

**Attributes (9.4.3):**
- All return 0 or null when closed
- codedRect computed from codedWidth/codedHeight
- visibleRect defaults to full frame, supports override
- colorSpace returns VideoColorSpace instance
- rotation defaults to 0
- flip defaults to false

**Methods (9.4.5):**
- allocationSize: calculates bytes needed for all pixel formats
- copyTo: async method returning Promise<PlaneLayout[]>
- clone: creates new VideoFrame sharing native resource
- close: idempotent, sets _closed flag
- metadata: returns copy of metadata object

**Pixel Formats Supported:**
- RGBA, RGBX, BGRA, BGRX (packed 4 bytes/pixel)
- I420, I420A (4:2:0 planar)
- I422, I422A (4:2:2 planar)
- I444, I444A (4:4:4 planar)
- NV12, NV12A, NV21 (semi-planar)
- 10-bit formats: I420P10, I422P10, I444P10, etc.

## Files Modified

- `lib/video-frame.ts`: Added format validation in buffer constructor
- `test/unit/video-frame.test.ts`: New test file with 41 tests

## Downstream Unblocked

- TODO-6.x: VideoEncoder.encode() takes VideoFrame
- TODO-4.x: VideoDecoder outputs VideoFrame
