# 6.6 Handoff: VideoEncoder Algorithms

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Algorithm | Steps Verified | Test |
|--------------|-----------|----------------|------|
| 6.6 | Schedule Dequeue Event | 1-3 | dequeue event tests (2) |
| 6.6 | Output EncodedVideoChunks | 1-9 | output tests (4) |
| 6.6 | Reset VideoEncoder | 1-8 | reset tests (5) |
| 6.6 | Close VideoEncoder | 1-4 | close tests (4) |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| Schedule Dequeue Event algorithm | 2 | YES |
| Output EncodedVideoChunks algorithm | 4 | YES |
| Reset VideoEncoder algorithm | 5 | YES |
| Close VideoEncoder algorithm | 4 | YES |
| Orientation handling | 2 | YES |
| SVC metadata (scalability modes) | 2 | YES |
| **Total** | **19** | **YES** |

## Tests Added

`test/unit/video-encoder-algorithms.test.ts`:

**Schedule Dequeue Event algorithm:**
- should fire dequeue event after output
- should coalesce multiple dequeue events

**Output EncodedVideoChunks algorithm:**
- should output EncodedVideoChunk with correct type
- should output EncodedVideoChunk with timestamp
- should invoke output callback with metadata
- should include decoderConfig in metadata for key frame

**Reset VideoEncoder algorithm:**
- should throw InvalidStateError if closed
- should set state to unconfigured
- should clear control message queue
- should clear encodeQueueSize to zero
- should allow reconfigure after reset

**Close VideoEncoder algorithm:**
- should set state to closed
- should work after configure
- should be idempotent
- should not invoke error callback for normal close

**Orientation handling:**
- should accept frames and produce output
- should clear orientation state on reset

**SVC metadata:**
- should configure with scalabilityMode if supported
- should encode with scalabilityMode configured

## Implementation Notes

VideoEncoder algorithms are fully implemented:
- Schedule Dequeue Event: Coalesces events via [[dequeue event scheduled]] slot
- Output EncodedVideoChunks: Returns EncodedVideoChunk with metadata.decoderConfig
- Reset: Clears all state, allows reconfigure
- Close: Releases resources, sets state to closed

The native layer provides metadata with decoderConfig for key frames, which is
a key difference from AudioEncoder.

## Files Modified

- `test/unit/video-encoder-algorithms.test.ts`: New test file with 19 tests

## Downstream Unblocked

- TODO-6.7: EncodedVideoChunkMetadata
