# 9.2 Handoff: AudioData Interface

## Status: COMPLETE

## Spec Compliance Mapping

| Spec Section | Requirement | Implementation | Test |
|--------------|-------------|----------------|------|
| 9.2.1 | Internal slots | Private _native/_closed | attribute tests |
| 9.2.2 | Constructor with AudioDataInit | lib/audio-data.ts:19-41 | constructor tests (14) |
| 9.2.2 | All AudioSampleFormat values | native supports u8/s16/s32/f32 (planar/interleaved) | format tests (8) |
| 9.2.3 | format attribute (nullable) | getter returns null if closed | format tests |
| 9.2.3 | sampleRate attribute | getter returns _native.sampleRate | sampleRate tests |
| 9.2.3 | numberOfFrames attribute | getter returns _native.numberOfFrames | numberOfFrames tests |
| 9.2.3 | numberOfChannels attribute | getter returns _native.numberOfChannels | numberOfChannels tests |
| 9.2.3 | timestamp attribute | getter returns _native.timestamp | timestamp tests |
| 9.2.3 | duration computed | (frames/sampleRate)*1000000 | duration tests (2) |
| 9.2.4 | allocationSize(options) | lib/audio-data.ts:67-78 | allocationSize tests (7) |
| 9.2.4 | copyTo(destination, options) | lib/audio-data.ts:80-112 | copyTo tests (8) |
| 9.2.4 | clone() | lib/audio-data.ts:114-123 | clone tests (3) |
| 9.2.4 | close() | lib/audio-data.ts:125-130 | close tests (3) |
| 9.2.5 | Compute Copy Element Count | native layer | planeIndex validation tests |
| 9.2.7 | AudioDataCopyToOptions | planeIndex, frameOffset, frameCount, format | copyTo option tests |

## Test Coverage

| Category | Count | All Pass? |
|----------|-------|-----------|
| 9.2.2 Constructor | 14 | YES |
| 9.2.3 Attributes | 9 | YES |
| 9.2.4 allocationSize | 7 | YES |
| 9.2.4 copyTo | 8 | YES |
| 9.2.4 clone | 3 | YES |
| 9.2.4 close | 3 | YES |
| Planar vs Interleaved | 2 | YES |
| Edge cases | 3 | YES |
| Type exports | 1 | YES |
| **Total** | **50** | **YES** |

## Tests Added

`test/unit/audio-data.test.ts`:

**9.2.2 Constructor:**
- should construct with valid init
- should accept format: u8
- should accept format: u8-planar
- should accept format: s16
- should accept format: s16-planar
- should accept format: s32
- should accept format: s32-planar
- should accept format: f32
- should accept format: f32-planar
- should accept ArrayBuffer as data
- should support stereo audio (2 channels)
- should support multi-channel audio (6 channels)
- should throw TypeError for invalid format
- should throw TypeError for missing data

**9.2.3 Attributes:**
- should have readonly format attribute
- should have readonly sampleRate attribute
- should support various sample rates
- should have readonly numberOfFrames attribute
- should have readonly numberOfChannels attribute
- should have readonly timestamp attribute in microseconds
- should support negative timestamp
- should compute duration correctly
- should compute duration for partial second

**9.2.4 allocationSize Method:**
- should return correct allocation size for f32 format
- should return correct allocation size for s16 format
- should return correct allocation size for planar format
- should throw TypeError if planeIndex is missing
- should throw RangeError if planeIndex > 0 for interleaved format
- should throw RangeError if planeIndex >= numberOfChannels for planar format
- should throw InvalidStateError if called after close

**9.2.4 copyTo Method:**
- should copy audio data to destination buffer
- should copy audio data to ArrayBuffer
- should support frameOffset in copyTo
- should support frameCount in copyTo
- should throw RangeError if destination buffer too small
- should throw InvalidStateError if called after close
- should throw TypeError if planeIndex is missing
- should throw RangeError if frameOffset >= numberOfFrames

**9.2.4 clone Method:**
- should create new AudioData via clone
- should share audio data between original and clone
- should throw InvalidStateError when cloning closed AudioData

**9.2.4 close Method:**
- should mark AudioData as closed
- should allow double close without error
- should return default values after close

**Planar vs Interleaved formats:**
- should handle planar format with multiple channels
- should handle interleaved format with multiple channels

**Edge cases:**
- should handle large audio data (>1MB)
- should handle single frame audio
- should handle 8-channel audio (7.1 surround)

**Type exports:**
- should export AudioData class

## Implementation Notes

AudioData is correctly implemented in lib/audio-data.ts:

**Constructor (9.2.2):**
- Accepts ArrayBuffer or ArrayBufferView
- Validates format, converts to Buffer for native
- Supports transfer option for ArrayBuffer detachment

**Attributes (9.2.3):**
- All return 0 or null when closed
- duration is computed as (numberOfFrames / sampleRate) * 1000000

**Methods (9.2.4):**
- allocationSize: validates planeIndex (required), returns bytes needed
- copyTo: validates buffer size, copies with optional frameOffset/frameCount
- clone: creates new AudioData sharing native resource
- close: idempotent, sets _closed flag

**Sample Formats:**
- Interleaved: u8, s16, s32, f32 (all channels in plane 0)
- Planar: u8-planar, s16-planar, s32-planar, f32-planar (one plane per channel)

## Files Modified

- `test/unit/audio-data.test.ts`: New test file with 50 tests
- `.claude/scratch/9.2-spec-analysis.md`: Spec analysis document

## Downstream Unblocked

- TODO-5.x: AudioEncoder.encode() takes AudioData
- TODO-3.x: AudioDecoder outputs AudioData
