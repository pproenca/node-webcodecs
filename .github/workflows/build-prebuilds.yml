name: build-prebuilds

# Concurrency: When called via workflow_call, inherits caller's concurrency.
# For direct triggers (workflow_dispatch, push), each run is independent.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

on:
  workflow_dispatch:
    inputs:
      cache_version:
        description: "Cache version (bump to force rebuild)"
        default: "v1"
  workflow_call:
    inputs:
      cache_version:
        description: "Cache version (bump to force rebuild)"
        type: string
        default: "v1"
  push:
    paths:
      - "src/**"
      - "binding.gyp"
      - ".github/workflows/build-prebuilds.yml"
      - "externals/jellyfin-ffmpeg"
  pull_request:
    paths:
      - "src/**"
      - "binding.gyp"
      - ".github/workflows/build-prebuilds.yml"
      - "externals/jellyfin-ffmpeg"

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
      id-token: write
      attestations: write
    uses: ./.github/workflows/build-ffmpeg.yml
    with:
      cache_version: ${{ inputs.cache_version || 'v1' }}

  build-prebuilds:
    needs: build-ffmpeg
    permissions:
      contents: read
      id-token: write
      attestations: write
    name: "prebuild-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    env:
      CACHE_VERSION: ${{ inputs.cache_version || 'v1' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin-arm64
            arch: arm64
          - os: macos-15-intel
            platform: darwin-x64
            arch: x64
          - os: ubuntu-24.04
            platform: linux-x64
            arch: x64

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.x"

      - name: Get jellyfin-ffmpeg commit hash
        id: ffmpeg-hash
        run: |
          cd externals/jellyfin-ffmpeg
          echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Restore FFmpeg cache
        id: cache-ffmpeg
        uses: actions/cache/restore@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ steps.ffmpeg-hash.outputs.hash }}-${{ env.CACHE_VERSION }}

      - name: Setup cached FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit == 'true'
        run: |
          echo "Using cached FFmpeg from jellyfin-ffmpeg build"
          ls -la ffmpeg-install/
          ls -la ffmpeg-install/lib/
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/ffmpeg-install/lib/pkgconfig" >> $GITHUB_ENV

      - name: Fix macOS 15 PerfPowerServices CPU bug
        if: runner.os == 'macOS'
        run: |
          # Workaround for known macOS 15 bug where PerfPowerServices consumes 100% CPU
          # See: https://github.com/actions/runner-images/issues/13358
          sudo defaults -currentHost write /Library/Preferences/com.apple.powerlogd SMCMonitorCadence 0
          sudo killall PerfPowerServices || true

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install pkg-config

      - name: Install build tools (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config

      # Fallback: Install system FFmpeg if cache miss (for local development)
      - name: Install FFmpeg (macOS) - cache miss
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          echo "::warning::FFmpeg cache miss - installing system FFmpeg (shared, not static)"
          brew install ffmpeg

      - name: Install FFmpeg (Ubuntu) - cache miss
        if: runner.os == 'Linux' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          echo "::warning::FFmpeg cache miss - installing system FFmpeg (shared, not static)"
          sudo apt-get install -y \
            ffmpeg \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev \
            libswresample-dev \
            libavfilter-dev

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build with prebuildify
        run: |
          npx prebuildify --napi --strip --arch=${{ matrix.arch }}

          # Verify expected structure (node-gyp-build expects node.napi.node)
          PLATFORM="${{ runner.os == 'macOS' && 'darwin' || 'linux' }}"
          PREBUILD_DIR="prebuilds/${PLATFORM}-${{ matrix.arch }}"

          if [ ! -f "$PREBUILD_DIR/node.napi.node" ]; then
            echo "Error: Expected $PREBUILD_DIR/node.napi.node"
            ls -laR prebuilds/
            exit 1
          fi
          echo "Prebuild OK: $PREBUILD_DIR/node.napi.node"
          ls -la "$PREBUILD_DIR/"

      - name: Build TypeScript
        run: npm run build:ts

      - name: Run Tests
        run: npm run test:fast

      - name: Upload prebuild
        uses: actions/upload-artifact@v6
        with:
          name: prebuild-${{ matrix.platform }}
          path: prebuilds/
          retention-days: 7

      - name: Attest prebuild artifact
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: prebuilds/*/node.napi.node
