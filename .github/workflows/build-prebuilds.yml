name: build-prebuilds

# Builds the node-webcodecs native addon for each platform.
# Downloads FFmpeg static libraries from GitHub Release and links them statically.
# Packages the result as platform-specific npm packages.

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

on:
  workflow_dispatch:
    inputs:
      deps_version:
        description: "FFmpeg dependencies version tag"
        default: "v1"
  workflow_call:
    inputs:
      deps_version:
        description: "FFmpeg dependencies version tag"
        type: string
        default: "v1"
  push:
    paths:
      - "src/**"
      - "binding.gyp"
      - ".github/workflows/build-prebuilds.yml"
  pull_request:
    paths:
      - "src/**"
      - "binding.gyp"
      - ".github/workflows/build-prebuilds.yml"

permissions: {}

jobs:
  build-prebuilds:
    permissions:
      contents: read
      id-token: write
      attestations: write
    name: "prebuild-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    env:
      DEPS_VERSION: ${{ inputs.deps_version || 'v8' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            platform: darwin-arm64
            arch: arm64
          - os: macos-15-intel
            platform: darwin-x64
            arch: x64
          - os: ubuntu-24.04
            platform: linux-x64
            arch: x64

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.x"

      - name: Fix macOS 15 PerfPowerServices CPU bug
        if: runner.os == 'macOS'
        run: |
          # Workaround for known macOS 15 bug where PerfPowerServices consumes 100% CPU
          # See: https://github.com/actions/runner-images/issues/13358
          sudo defaults -currentHost write /Library/Preferences/com.apple.powerlogd SMCMonitorCadence 0
          sudo killall PerfPowerServices || true

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install pkg-config

      - name: Install build tools (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config

      - name: Download FFmpeg from Release
        uses: dsaltares/fetch-gh-release-asset@1.1.2
        with:
          repo: ${{ github.repository }}
          version: tags/deps-${{ env.DEPS_VERSION }}
          # Use glibc variant for Linux (musl libs can't link into glibc shared objects)
          file: ffmpeg-${{ matrix.platform }}${{ runner.os == 'Linux' && '-glibc' || '' }}.tar.gz
          target: ffmpeg-${{ matrix.platform }}.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract FFmpeg and Set Environment
        run: |
          mkdir -p ffmpeg-install
          tar -xzvf ffmpeg-${{ matrix.platform }}.tar.gz -C ffmpeg-install

          # Set FFMPEG_ROOT for ffmpeg-paths.js to use --define-variable=prefix=
          echo "FFMPEG_ROOT=${{ github.workspace }}/ffmpeg-install" >> $GITHUB_ENV

          ls -la ffmpeg-install/lib/
          ls -la ffmpeg-install/lib/pkgconfig/ || { echo "ERROR: No pkgconfig directory"; exit 1; }

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build with prebuildify
        run: |
          npx prebuildify --napi --strip --arch=${{ matrix.arch }}

          # prebuildify 6.x with scoped packages creates @scope+name.node
          # but node-gyp-build expects node.napi.node - rename if needed
          PREBUILD_DIR="prebuilds/${{ matrix.platform }}"

          if [ ! -f "$PREBUILD_DIR/node.napi.node" ]; then
            # Look for scoped package naming pattern
            SCOPED_FILE=$(find "$PREBUILD_DIR" -name "*.node" -type f | head -1)
            if [ -n "$SCOPED_FILE" ]; then
              echo "Renaming $SCOPED_FILE to node.napi.node"
              mv "$SCOPED_FILE" "$PREBUILD_DIR/node.napi.node"
            else
              echo "Error: No .node file found in $PREBUILD_DIR"
              ls -laR prebuilds/
              exit 1
            fi
          fi
          echo "Prebuild OK: $PREBUILD_DIR/node.napi.node"
          ls -la "$PREBUILD_DIR/"

      - name: Build TypeScript
        run: npm run build:ts

      - name: Run Tests
        run: npm run test:fast

      - name: Package as platform npm package
        run: |
          # Read version from package.json
          VERSION=$(node -p "require('./package.json').version")

          # Create platform package directory
          PKG_DIR="packages/@pproenca/node-webcodecs-${{ matrix.platform }}"
          mkdir -p "$PKG_DIR/bin"

          # Copy the native addon (use matrix.platform directly)
          cp "prebuilds/${{ matrix.platform }}/node.napi.node" "$PKG_DIR/bin/"

          # Create package.json for the platform package
          cat > "$PKG_DIR/package.json" << EOF
          {
            "name": "@pproenca/node-webcodecs-${{ matrix.platform }}",
            "version": "${VERSION}",
            "description": "node-webcodecs native addon for ${{ matrix.platform }}",
            "os": ["${{ runner.os == 'macOS' && 'darwin' || 'linux' }}"],
            "cpu": ["${{ matrix.arch }}"],
            "files": ["bin/"],
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/${{ github.repository }}"
            }
          }
          EOF

          echo "Created platform package:"
          cat "$PKG_DIR/package.json"
          ls -la "$PKG_DIR/bin/"

          # Create tarball to preserve permissions
          # NOTE: Use ./@pproenca/... to prevent BSD tar from interpreting @ as
          # a special directive (@ prefix means "read archive" on macOS tar)
          cd packages
          tar -cvf "@pproenca-node-webcodecs-${{ matrix.platform }}.tar" "./@pproenca/node-webcodecs-${{ matrix.platform }}/"

      - name: Upload platform package
        uses: actions/upload-artifact@v6
        with:
          name: platform-pkg-${{ matrix.platform }}
          path: packages/@pproenca-node-webcodecs-${{ matrix.platform }}.tar
          retention-days: 7
          compression-level: 0

      - name: Attest platform package
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: packages/@pproenca/node-webcodecs-${{ matrix.platform }}/bin/node.napi.node
