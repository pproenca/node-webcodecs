name: npm-smoke

on:
  release:
    types: [published]

permissions: {}

jobs:
  release-smoke-test:
    name: "${{ github.event.release.tag_name }} ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64-node-npm
            os: ubuntu-24.04
            runtime: node
            package-manager: npm
          - name: linux-x64-node-pnpm
            os: ubuntu-24.04
            runtime: node
            package-manager: pnpm
          - name: linux-x64-node-yarn
            os: ubuntu-24.04
            runtime: node
            package-manager: yarn

          - name: darwin-x64-node-npm
            os: macos-15-intel
            runtime: node
            package-manager: npm
          - name: darwin-x64-node-pnpm
            os: macos-15-intel
            runtime: node
            package-manager: pnpm
          - name: darwin-x64-node-yarn
            os: macos-15-intel
            runtime: node
            package-manager: yarn

          - name: darwin-arm64-node-npm
            os: macos-latest
            runtime: node
            package-manager: npm
          - name: darwin-arm64-node-pnpm
            os: macos-latest
            runtime: node
            package-manager: pnpm
          - name: darwin-arm64-node-yarn
            os: macos-latest
            runtime: node
            package-manager: yarn

    steps:
      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.x"

      - name: Install pnpm
        if: matrix.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # Note: FFmpeg is NOT installed here intentionally.
      # Prebuilds use static linking via jellyfin-ffmpeg and should be self-contained.
      # If smoke tests fail without FFmpeg, it indicates a static linking problem.

      - name: Version
        id: version
        uses: actions/github-script@v8
        with:
          script: |
            core.setOutput('semver', context.payload.release.tag_name.replace('v',''))

      - name: Create package.json
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: package.json
          contents: |
            {
              "dependencies": {
                "@pproenca/node-webcodecs": "${{ steps.version.outputs.semver }}"
              },
              "type": "module"
            }

      - name: Create release.mjs
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: release.mjs
          contents: |
            import { VideoEncoder, VideoFrame } from '@pproenca/node-webcodecs';
            console.log('VideoEncoder:', typeof VideoEncoder);
            console.log('VideoFrame:', typeof VideoFrame);
            if (typeof VideoEncoder !== 'function') process.exit(1);
            if (typeof VideoFrame !== 'function') process.exit(1);
            console.log('Smoke test passed!');

      - name: Run with npm
        if: matrix.package-manager == 'npm'
        run: |
          npm install
          node release.mjs

      - name: Run with pnpm
        if: matrix.package-manager == 'pnpm'
        run: |
          pnpm install
          node release.mjs

      - name: Run with yarn
        if: matrix.package-manager == 'yarn'
        run: |
          corepack enable
          yarn set version stable
          yarn config set enableImmutableInstalls false
          yarn config set nodeLinker node-modules
          yarn install
          node release.mjs
