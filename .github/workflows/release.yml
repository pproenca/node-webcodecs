name: release

# Releases must NEVER be canceled - partial releases are dangerous
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  workflow_dispatch:
  release:
    types: [published]

permissions: {}

jobs:
  # Build prebuilt binaries for all platforms (also builds FFmpeg via nested workflow call)
  build-prebuilds:
    uses: ./.github/workflows/build-prebuilds.yml

  # Publish main package with bundled prebuilds
  publish:
    name: "Publish"
    needs: [build-prebuilds]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build TypeScript
        run: npm run build:ts

      - name: Download all prebuilds
        uses: actions/download-artifact@v7
        with:
          pattern: prebuild-*
          path: prebuilds-artifacts

      - name: Assemble prebuilds directory
        run: |
          mkdir -p prebuilds

          # Each artifact contains prebuilds/{platform}-{arch}/node.napi.node
          # Merge them into a single prebuilds/ directory
          for artifact_dir in prebuilds-artifacts/*/; do
            if [ -d "${artifact_dir}prebuilds" ]; then
              cp -r "${artifact_dir}prebuilds"/* prebuilds/
            else
              # Fallback: artifact might be directly the prebuilds content
              echo "::warning::Unexpected artifact structure in $artifact_dir - attempting fallback copy"
              cp -r "$artifact_dir"* prebuilds/ || echo "::warning::Fallback copy failed for $artifact_dir"
            fi
          done

          echo "Final prebuilds structure:"
          ls -laR prebuilds/

          # Verify all platforms present
          for platform in darwin-arm64 darwin-x64 linux-x64; do
            if [ ! -f "prebuilds/$platform/node.napi.node" ]; then
              echo "Error: Missing prebuild for $platform"
              exit 1
            fi
            echo "OK: prebuilds/$platform/node.napi.node"
          done

      # OIDC Trusted Publishing - no NPM_TOKEN needed (Node 24+)
      # Configure trusted publisher at npmjs.com package settings
      - name: Publish main package
        run: npm publish --provenance --access public
