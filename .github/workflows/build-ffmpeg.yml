# FFmpeg Static Binary Build Workflow
# Based on GitHub Actions best practices for multi-platform native binary builds
#
# Key patterns applied:
# - Matrix strategy for parallel platform builds
# - Native runners (not QEMU emulation) for macOS arm64/x64
# - Docker buildx with GHA cache for Linux builds
# - Tar archives to preserve file permissions in artifacts
# - OIDC for npm publishing (no long-lived tokens)
# - Minimal GITHUB_TOKEN permissions per job
# - Pinned action versions for security
#
# Runner/Action versions updated: January 2026
# - macos-13 deprecated Dec 2025, using macos-15-intel for x64
# - macos-15 for ARM64 (macos-latest)
# - ubuntu-latest = Ubuntu 24.04
# - All actions on Node.js 24 (v5/v6 releases)

name: Build FFmpeg Static Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version/branch to build'
        required: false
        default: 'master'
      skip_publish:
        description: 'Skip npm publish step'
        required: false
        type: boolean
        default: false

# Default minimal permissions - override per job
permissions:
  contents: read

env:
  # Codec versions - update these for reproducible builds (Jan 2026)
  X264_VERSION: 'stable'
  X265_VERSION: '3.6'
  LIBVPX_VERSION: 'v1.15.2'
  LIBAOM_VERSION: 'v3.12.1'
  OPUS_VERSION: '1.5.2'
  LAME_VERSION: '3.100'
  FFMPEG_VERSION: 'n8.0'
  # npm scope for platform packages
  NPM_SCOPE: '@pproenca/ffmpeg'
  # Bump this to invalidate all caches
  CACHE_VERSION: '6'

jobs:
  # ============================================================================
  # Linux x64 Build - Docker-based for musl static linking
  # ============================================================================
  build-linux-x64:
    name: Build Linux x64 (musl)
    runs-on: ubuntu-24.04  # Explicit version for reproducibility
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build FFmpeg in Alpine container
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.linux-x64
          push: false
          load: true
          tags: ffmpeg-builder:linux-x64
          cache-from: type=gha,scope=linux-x64
          cache-to: type=gha,mode=max,scope=linux-x64

      - name: Extract binaries from container
        run: |
          mkdir -p artifacts/linux-x64
          docker create --name extract ffmpeg-builder:linux-x64
          docker cp extract:/build/bin/ffmpeg artifacts/linux-x64/ffmpeg
          docker cp extract:/build/bin/ffprobe artifacts/linux-x64/ffprobe
          docker rm extract

          # Verify static linking
          echo "Verifying static binary..."
          file artifacts/linux-x64/ffmpeg
          ! ldd artifacts/linux-x64/ffmpeg 2>/dev/null || echo "Warning: binary may have dynamic deps"

          # Get version info
          chmod +x artifacts/linux-x64/ffmpeg
          ./artifacts/linux-x64/ffmpeg -version > artifacts/linux-x64/version.txt 2>&1 || true

      # Tar to preserve permissions (chmod +x is lost in artifact upload)
      - name: Package artifacts
        run: |
          cd artifacts
          tar -cvf linux-x64.tar linux-x64/

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-linux-x64
          path: artifacts/linux-x64.tar
          retention-days: 7
          compression-level: 0  # Already compressed, faster upload

  # ============================================================================
  # macOS Builds - Native runners for both architectures
  # ============================================================================
  build-macos:
    name: Build macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # macos-13 deprecated Dec 2025 - use macos-15-intel for x64
          # macos-15-intel available until Aug 2027 (last Intel runner)
          - runner: macos-15-intel
            arch: x64
            target: x86_64
          # macos-15 is ARM64 (same as macos-latest since Aug 2025)
          - runner: macos-15
            arch: arm64
            target: arm64

    env:
      TARGET: ${{ github.workspace }}/ffmpeg_build
      ARCH: ${{ matrix.target }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install build dependencies
        run: |
          brew install automake libtool nasm cmake pkg-config

      - name: Cache compiled libraries
        uses: actions/cache@v5
        id: cache-libs
        with:
          path: |
            ${{ github.workspace }}/ffmpeg_build
            ${{ github.workspace }}/ffmpeg_sources
          key: macos-${{ matrix.arch }}-libs-${{ env.X264_VERSION }}-${{ env.LIBVPX_VERSION }}-${{ env.LIBAOM_VERSION }}-v${{ env.CACHE_VERSION }}
          restore-keys: |
            macos-${{ matrix.arch }}-libs-

      - name: Build codec libraries
        if: steps.cache-libs.outputs.cache-hit != 'true'
        run: |
          set -e
          export PATH="$TARGET/bin:$PATH"
          export PKG_CONFIG_PATH="$TARGET/lib/pkgconfig"
          mkdir -p "$TARGET"/{include,lib,bin}
          mkdir -p "${{ github.workspace }}/ffmpeg_sources" && cd "${{ github.workspace }}/ffmpeg_sources"

          echo "=== Building nasm ==="
          curl -sL https://www.nasm.us/pub/nasm/releasebuilds/2.16.03/nasm-2.16.03.tar.bz2 | tar xj
          cd nasm-2.16.03
          ./configure --prefix="$TARGET"
          make -j$(sysctl -n hw.ncpu)
          make install
          cd ..

          echo "=== Building x264 (GPL) ==="
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure \
            --prefix="$TARGET" \
            --enable-static \
            --disable-shared \
            --enable-pic \
            --disable-cli \
            --extra-cflags="-arch $ARCH" \
            --extra-ldflags="-arch $ARCH"
          make -j$(sysctl -n hw.ncpu)
          make install
          cd ..

          echo "=== Building x265 (GPL) ==="
          git clone --depth 1 https://bitbucket.org/multicoreware/x265_git.git
          mkdir -p x265_git/build/xcode && cd x265_git/build/xcode
          cmake \
            -DCMAKE_INSTALL_PREFIX="$TARGET" \
            -DLIB_INSTALL_DIR="$TARGET/lib" \
            -DENABLE_SHARED=OFF \
            -DENABLE_CLI=OFF \
            -DCMAKE_OSX_ARCHITECTURES=$ARCH \
            ../../source
          make -j$(sysctl -n hw.ncpu)
          make install
          # x265 cmake doesn't always install .pc file, create it manually
          mkdir -p "$TARGET/lib/pkgconfig"
          cat > "$TARGET/lib/pkgconfig/x265.pc" << PCEOF
          prefix=$TARGET
          exec_prefix=\${prefix}
          libdir=\${prefix}/lib
          includedir=\${prefix}/include

          Name: x265
          Description: H.265/HEVC video encoder
          Version: 3.6
          Libs: -L\${libdir} -lx265
          Libs.private: -lc++ -lm -lpthread
          Cflags: -I\${includedir}
          PCEOF
          cd ../../..

          echo "=== Building libvpx (BSD) ==="
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx.git
          cd libvpx
          # Get Darwin version for target string (macOS 15 = Darwin 24)
          DARWIN_VERSION=$(uname -r | cut -d. -f1)
          if [ "$ARCH" = "arm64" ]; then
            VPX_TARGET="arm64-darwin${DARWIN_VERSION}-gcc"
          else
            VPX_TARGET="x86_64-darwin${DARWIN_VERSION}-gcc"
          fi
          echo "Using libvpx target: $VPX_TARGET"
          ./configure \
            --prefix="$TARGET" \
            --target=$VPX_TARGET \
            --enable-vp8 \
            --enable-vp9 \
            --disable-examples \
            --disable-unit-tests \
            --enable-vp9-highbitdepth \
            --enable-static \
            --disable-shared
          make -j$(sysctl -n hw.ncpu)
          make install
          cd ..

          echo "=== Building libaom (AV1, BSD) ==="
          git clone --depth 1 --branch ${{ env.LIBAOM_VERSION }} https://aomedia.googlesource.com/aom
          mkdir aom_build && cd aom_build
          cmake \
            -DCMAKE_INSTALL_PREFIX="$TARGET" \
            -DBUILD_SHARED_LIBS=OFF \
            -DENABLE_DOCS=OFF \
            -DENABLE_EXAMPLES=OFF \
            -DENABLE_TESTS=OFF \
            -DCMAKE_OSX_ARCHITECTURES=$ARCH \
            ../aom
          make -j$(sysctl -n hw.ncpu)
          make install
          cd ..

          echo "=== Building libopus (BSD) ==="
          curl -sL https://downloads.xiph.org/releases/opus/opus-${{ env.OPUS_VERSION }}.tar.gz | tar xz
          cd opus-${{ env.OPUS_VERSION }}
          ./configure \
            --prefix="$TARGET" \
            --disable-shared \
            --enable-static \
            CFLAGS="-arch $ARCH" \
            LDFLAGS="-arch $ARCH"
          make -j$(sysctl -n hw.ncpu)
          make install
          cd ..

          echo "=== Building libmp3lame (LGPL) ==="
          curl -sL "https://downloads.sourceforge.net/project/lame/lame/${{ env.LAME_VERSION }}/lame-${{ env.LAME_VERSION }}.tar.gz" | tar xz
          cd lame-${{ env.LAME_VERSION }}
          ./configure \
            --prefix="$TARGET" \
            --disable-shared \
            --enable-static \
            --enable-nasm \
            CFLAGS="-arch $ARCH" \
            LDFLAGS="-arch $ARCH"
          make -j$(sysctl -n hw.ncpu)
          make install
          cd ..

      - name: Build FFmpeg
        run: |
          set -e
          export PATH="$TARGET/bin:$PATH"
          export PKG_CONFIG_PATH="$TARGET/lib/pkgconfig"

          mkdir -p "${{ github.workspace }}/ffmpeg_sources"
          cd "${{ github.workspace }}/ffmpeg_sources"

          # Clone if not cached (use GitHub mirror - more reliable than git.ffmpeg.org)
          if [ ! -d ffmpeg ]; then
            for i in 1 2 3; do
              git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg && break
              echo "Clone attempt $i failed, retrying in 10s..."
              sleep 10
            done
          fi

          cd ffmpeg

          # Clean previous builds
          make distclean 2>/dev/null || true

          ./configure \
            --cc="clang -arch $ARCH" \
            --prefix="$TARGET" \
            --extra-cflags="-I$TARGET/include -fno-stack-check" \
            --extra-ldflags="-L$TARGET/lib" \
            --pkg-config-flags="--static" \
            --enable-static \
            --disable-shared \
            --enable-gpl \
            --enable-version3 \
            --enable-pthreads \
            --enable-runtime-cpudetect \
            --disable-ffplay \
            --disable-doc \
            --disable-debug \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libaom \
            --enable-libopus \
            --enable-libmp3lame

          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Verify and strip binaries
        run: |
          echo "=== Checking dynamic library dependencies ==="
          otool -L "$TARGET/bin/ffmpeg"

          # Should only show /usr/lib/libSystem.B.dylib
          DEPS=$(otool -L "$TARGET/bin/ffmpeg" | grep -v libSystem | grep -v ":" | wc -l)
          if [ "$DEPS" -gt 0 ]; then
            echo "Warning: Found unexpected dynamic dependencies"
            otool -L "$TARGET/bin/ffmpeg" | grep -v libSystem | grep -v ":"
          fi

          echo "=== Stripping debug symbols ==="
          strip "$TARGET/bin/ffmpeg"
          strip "$TARGET/bin/ffprobe"

          echo "=== Binary sizes ==="
          ls -lh "$TARGET/bin/ffmpeg" "$TARGET/bin/ffprobe"

          echo "=== Version info ==="
          "$TARGET/bin/ffmpeg" -version

      - name: Package artifacts
        run: |
          mkdir -p artifacts/darwin-${{ matrix.arch }}
          cp "$TARGET/bin/ffmpeg" artifacts/darwin-${{ matrix.arch }}/
          cp "$TARGET/bin/ffprobe" artifacts/darwin-${{ matrix.arch }}/
          "$TARGET/bin/ffmpeg" -version > artifacts/darwin-${{ matrix.arch }}/version.txt 2>&1 || true

          cd artifacts
          tar -cvf darwin-${{ matrix.arch }}.tar darwin-${{ matrix.arch }}/

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-darwin-${{ matrix.arch }}
          path: artifacts/darwin-${{ matrix.arch }}.tar
          retention-days: 7
          compression-level: 0

  # ============================================================================
  # Package npm modules
  # ============================================================================
  package-npm:
    name: Package npm modules
    runs-on: ubuntu-24.04
    needs: [build-linux-x64, build-macos]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts

      - name: Extract and organize binaries
        run: |
          set -e

          # Extract tarballs
          for artifact in artifacts/ffmpeg-*/; do
            tarball=$(find "$artifact" -name "*.tar" | head -1)
            if [ -n "$tarball" ]; then
              echo "Extracting $tarball"
              tar -xvf "$tarball" -C "$artifact"
            fi
          done

          # Debug: show structure
          find artifacts -type f -name "ffmpeg*" -o -name "version.txt"

          # Create platform package directories
          mkdir -p packages

          for platform in linux-x64 darwin-x64 darwin-arm64; do
            pkg_dir="packages/${{ env.NPM_SCOPE }}-${platform}"
            mkdir -p "$pkg_dir/bin"

            # Map artifact names to package names
            if [ "$platform" = "darwin-x64" ]; then
              src_dir="artifacts/ffmpeg-darwin-x64/darwin-x64"
            elif [ "$platform" = "darwin-arm64" ]; then
              src_dir="artifacts/ffmpeg-darwin-arm64/darwin-arm64"
            else
              src_dir="artifacts/ffmpeg-linux-x64/linux-x64"
            fi

            cp "$src_dir/ffmpeg" "$pkg_dir/bin/"
            cp "$src_dir/ffprobe" "$pkg_dir/bin/"
            chmod +x "$pkg_dir/bin/"*

            # Get version from tag or use 0.0.0-dev
            VERSION="${GITHUB_REF_NAME#v}"
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              VERSION="0.0.0-dev"
            fi

            # Create platform-specific package.json
            cat > "$pkg_dir/package.json" << EOF
          {
            "name": "${{ env.NPM_SCOPE }}-${platform}",
            "version": "${VERSION}",
            "description": "FFmpeg static binary for ${platform}",
            "os": ["$(echo $platform | cut -d'-' -f1 | sed 's/darwin/darwin/')"],
            "cpu": ["$(echo $platform | cut -d'-' -f2 | sed 's/x64/x64/;s/arm64/arm64/')"],
            "files": ["bin/"],
            "license": "GPL-2.0-or-later",
            "repository": {
              "type": "git",
              "url": "https://github.com/${{ github.repository }}"
            }
          }
          EOF

            # Fix os field
            if [[ "$platform" == darwin-* ]]; then
              sed -i 's/"os": \["darwin"\]/"os": ["darwin"]/' "$pkg_dir/package.json"
            else
              sed -i 's/"os": \["linux"\]/"os": ["linux"]/' "$pkg_dir/package.json"
            fi

            echo "Created package: $pkg_dir"
            cat "$pkg_dir/package.json"
          done

      - name: Create main package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            VERSION="0.0.0-dev"
          fi

          mkdir -p packages/${{ env.NPM_SCOPE }}

          cat > packages/${{ env.NPM_SCOPE }}/package.json << EOF
          {
            "name": "${{ env.NPM_SCOPE }}",
            "version": "${VERSION}",
            "description": "FFmpeg static binaries for Node.js",
            "main": "index.js",
            "types": "index.d.ts",
            "scripts": {
              "postinstall": "node install.js"
            },
            "optionalDependencies": {
              "${{ env.NPM_SCOPE }}-linux-x64": "${VERSION}",
              "${{ env.NPM_SCOPE }}-darwin-x64": "${VERSION}",
              "${{ env.NPM_SCOPE }}-darwin-arm64": "${VERSION}"
            },
            "license": "GPL-2.0-or-later",
            "repository": {
              "type": "git",
              "url": "https://github.com/${{ github.repository }}"
            },
            "keywords": ["ffmpeg", "video", "audio", "encoding", "webcodecs"],
            "engines": {
              "node": ">=16"
            }
          }
          EOF

          # Create index.js with binary resolution
          cat > packages/${{ env.NPM_SCOPE }}/index.js << 'EOF'
          const path = require('path');
          const { execSync, spawn } = require('child_process');

          const PLATFORMS = {
            'darwin-arm64': '${{ env.NPM_SCOPE }}-darwin-arm64',
            'darwin-x64': '${{ env.NPM_SCOPE }}-darwin-x64',
            'linux-x64': '${{ env.NPM_SCOPE }}-linux-x64',
          };

          function getBinaryPath(binary = 'ffmpeg') {
            const platform = `${process.platform}-${process.arch}`;
            const pkg = PLATFORMS[platform];

            if (!pkg) {
              throw new Error(
                `Unsupported platform: ${platform}. ` +
                `Supported: ${Object.keys(PLATFORMS).join(', ')}`
              );
            }

            try {
              const pkgPath = require.resolve(`${pkg}/package.json`);
              return path.join(path.dirname(pkgPath), 'bin', binary);
            } catch (e) {
              throw new Error(
                `Binary package ${pkg} not found. ` +
                `Run: npm install --include=optional`
              );
            }
          }

          function ffmpeg(args, options = {}) {
            const binary = getBinaryPath('ffmpeg');
            if (typeof args === 'string') {
              return execSync(`"${binary}" ${args}`, { encoding: 'utf8', ...options });
            }
            return spawn(binary, args, options);
          }

          function ffprobe(args, options = {}) {
            const binary = getBinaryPath('ffprobe');
            if (typeof args === 'string') {
              return execSync(`"${binary}" ${args}`, { encoding: 'utf8', ...options });
            }
            return spawn(binary, args, options);
          }

          module.exports = {
            getBinaryPath,
            ffmpegPath: getBinaryPath('ffmpeg'),
            ffprobePath: getBinaryPath('ffprobe'),
            ffmpeg,
            ffprobe,
          };
          EOF

          # Create TypeScript definitions
          cat > packages/${{ env.NPM_SCOPE }}/index.d.ts << 'EOF'
          import { SpawnOptions, ChildProcess, ExecSyncOptions } from 'child_process';

          export function getBinaryPath(binary?: 'ffmpeg' | 'ffprobe'): string;
          export const ffmpegPath: string;
          export const ffprobePath: string;

          export function ffmpeg(args: string, options?: ExecSyncOptions): string;
          export function ffmpeg(args: string[], options?: SpawnOptions): ChildProcess;

          export function ffprobe(args: string, options?: ExecSyncOptions): string;
          export function ffprobe(args: string[], options?: SpawnOptions): ChildProcess;
          EOF

          # Create install verification script
          cat > packages/${{ env.NPM_SCOPE }}/install.js << 'EOF'
          const { getBinaryPath } = require('./index');
          const { execSync } = require('child_process');

          try {
            const ffmpegPath = getBinaryPath('ffmpeg');
            const version = execSync(`"${ffmpegPath}" -version`, { encoding: 'utf8' });
            console.log('FFmpeg binary verified:', ffmpegPath);
            console.log(version.split('\n')[0]);
          } catch (e) {
            console.warn('Warning: FFmpeg binary not found for this platform');
            console.warn(e.message);
          }
          EOF

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v6
        with:
          name: npm-packages
          path: packages/
          retention-days: 7

  # ============================================================================
  # Publish to npm (only on tag push)
  # ============================================================================
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-24.04
    needs: [package-npm]
    if: startsWith(github.ref, 'refs/tags/v') && !inputs.skip_publish
    permissions:
      contents: read
      id-token: write  # Required for npm provenance

    environment:
      name: npm
      url: https://www.npmjs.com/package/${{ env.NPM_SCOPE }}

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Download npm packages
        uses: actions/download-artifact@v7
        with:
          name: npm-packages
          path: packages

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -e

          # Publish platform-specific packages first
          for pkg in packages/${{ env.NPM_SCOPE }}-*/; do
            echo "Publishing $pkg"
            cd "$pkg"
            npm publish --access public --provenance
            cd - > /dev/null
          done

          # Wait for registry propagation
          sleep 10

          # Publish main package
          echo "Publishing main package"
          cd "packages/${{ env.NPM_SCOPE }}"
          npm publish --access public --provenance

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: [build-linux-x64, build-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Extract and repackage with better names
          for artifact in artifacts/ffmpeg-*/; do
            tarball=$(find "$artifact" -name "*.tar" | head -1)
            if [ -n "$tarball" ]; then
              platform=$(basename "$artifact" | sed 's/ffmpeg-//')
              tar -xf "$tarball" -C artifacts/

              # Create release tarball with version
              cd artifacts
              tar -czvf "../release/ffmpeg-${GITHUB_REF_NAME}-${platform}.tar.gz" "${platform}/"
              cd ..
            fi
          done

          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## FFmpeg Static Binaries

            This release includes statically linked FFmpeg binaries for:
            - Linux x64 (musl libc, fully static)
            - macOS x64 (Intel)
            - macOS arm64 (Apple Silicon)

            ### Included Codecs
            - H.264 (libx264) - GPL
            - H.265/HEVC (libx265) - GPL
            - VP8/VP9 (libvpx) - BSD
            - AV1 (libaom) - BSD
            - Opus (libopus) - BSD
            - MP3 (libmp3lame) - LGPL

            ### npm Installation
            ```bash
            npm install ${{ env.NPM_SCOPE }}
            ```

            ### License
            These binaries are licensed under GPL v2+ due to the inclusion of libx264 and libx265.
