name: build-ffmpeg

# Concurrency: When called via workflow_call, inherits caller's concurrency.
# For direct triggers (workflow_dispatch, push), each run is independent.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# Source of truth for FFmpeg version and cache version.
# To change these values globally, set repository variables in GitHub Settings:
#   Settings > Secrets and variables > Actions > Variables
#   - FFMPEG_VERSION (e.g., "8.0.1")
#   - FFMPEG_CACHE_VERSION (e.g., "v2")
env:
  CACHE_VERSION: ${{ vars.FFMPEG_CACHE_VERSION || 'v2' }}
  DEFAULT_FFMPEG_VERSION: ${{ vars.FFMPEG_VERSION || '8.0.1' }}

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: "FFmpeg version to build (leave empty for default)"
        required: false
        default: ""
      force_rebuild:
        description: "Force rebuild (ignore cache)"
        type: boolean
        default: false
      upload_caches:
        description: "Upload caches as artifacts for debugging"
        type: boolean
        default: false
  workflow_call:
    inputs:
      ffmpeg_version:
        description: "FFmpeg version to build (leave empty for default)"
        required: false
        type: string
        default: ""
  push:
    paths:
      - ".github/workflows/build-ffmpeg.yml"
      - "ffmpeg/**"

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
    name: "ffmpeg-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin-arm64
            configure_flags: --enable-cross-compile --arch=arm64
          - os: macos-13
            platform: darwin-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linux-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linuxmusl-x64
            container: alpine:3.19
            configure_flags: ""

    steps:
      - uses: actions/checkout@v6

      # Cache FFmpeg build (skip for Alpine container - cache action doesn't work well there)
      - name: Restore FFmpeg cache
        if: ${{ !matrix.container && github.event.inputs.force_rebuild != 'true' }}
        id: cache-ffmpeg
        uses: actions/cache/restore@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ github.event.inputs.ffmpeg_version || env.DEFAULT_FFMPEG_VERSION }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            ffmpeg-${{ matrix.platform }}-${{ github.event.inputs.ffmpeg_version || env.DEFAULT_FFMPEG_VERSION }}-

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm pkg-config x264 x265 libvpx opus aom lame

      - name: Install dependencies (Linux glibc)
        if: runner.os == 'Linux' && !matrix.container
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config \
            libx264-dev libx265-dev libvpx-dev libopus-dev libaom-dev libmp3lame-dev

      - name: Install dependencies (Linux musl)
        if: matrix.container == 'alpine:3.19'
        run: |
          apk add --no-cache build-base nasm yasm pkgconf curl \
            x264-dev x265-dev libvpx-dev opus-dev aom-dev lame-dev

      - name: Download FFmpeg source
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        env:
          FFMPEG_VERSION: ${{ github.event.inputs.ffmpeg_version || env.DEFAULT_FFMPEG_VERSION }}
        run: |
          curl -L https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz | tar xJ
          mv ffmpeg-${FFMPEG_VERSION} ffmpeg-src

      - name: Configure FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        working-directory: ffmpeg-src
        run: |
          ./configure \
            --prefix=${{ github.workspace }}/ffmpeg-install \
            --enable-shared \
            --disable-static \
            --disable-programs \
            --disable-doc \
            --enable-gpl \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libopus \
            --enable-libaom \
            --enable-libmp3lame \
            ${{ matrix.configure_flags }}

      - name: Build FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        working-directory: ffmpeg-src
        run: make -j$(nproc || sysctl -n hw.ncpu)

      - name: Install FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        working-directory: ffmpeg-src
        run: make install

      - name: Save FFmpeg cache
        if: ${{ !matrix.container && steps.cache-ffmpeg.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ github.event.inputs.ffmpeg_version || env.DEFAULT_FFMPEG_VERSION }}-${{ env.CACHE_VERSION }}

      - name: Upload cache as artifact (debug)
        if: ${{ github.event.inputs.upload_caches == 'true' }}
        uses: actions/upload-artifact@v6
        with:
          name: cache-ffmpeg-${{ matrix.platform }}
          path: ffmpeg-install
          retention-days: 3

      - name: Package libraries and headers
        env:
          FFMPEG_VERSION: ${{ github.event.inputs.ffmpeg_version || env.DEFAULT_FFMPEG_VERSION }}
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          mkdir -p ffmpeg-${{ matrix.platform }}/include
          # Copy libraries (macOS uses .dylib, Linux uses .so)
          cp -P ffmpeg-install/lib/*.dylib ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          cp -P ffmpeg-install/lib/*.so* ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          # Copy pkgconfig files (needed for compilation against this FFmpeg)
          cp -r ffmpeg-install/lib/pkgconfig ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          # Copy headers (use cp -r on directory itself to avoid glob issues on Alpine)
          cp -r ffmpeg-install/include/. ffmpeg-${{ matrix.platform }}/include/
          echo "{\"ffmpeg\": \"${FFMPEG_VERSION}\"}" > ffmpeg-${{ matrix.platform }}/versions.json

      - uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}
          retention-days: 7
