name: Build FFmpeg

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: "FFmpeg version to build"
        required: true
        default: "7.1"
  push:
    paths:
      - ".github/workflows/build-ffmpeg.yml"
      - "ffmpeg/**"

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
    name: "ffmpeg-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin-arm64
            configure_flags: --enable-cross-compile --arch=arm64
          - os: macos-13
            platform: darwin-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linux-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linuxmusl-x64
            container: alpine:3.19
            configure_flags: ""

    steps:
      - uses: actions/checkout@v5

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm pkg-config x264 x265 libvpx opus

      - name: Install dependencies (Linux glibc)
        if: runner.os == 'Linux' && !matrix.container
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config \
            libx264-dev libx265-dev libvpx-dev libopus-dev

      - name: Install dependencies (Linux musl)
        if: matrix.container == 'alpine:3.19'
        run: |
          apk add --no-cache build-base nasm yasm pkgconf curl \
            x264-dev x265-dev libvpx-dev opus-dev

      - name: Download FFmpeg source
        run: |
          curl -L https://ffmpeg.org/releases/ffmpeg-${{ github.event.inputs.ffmpeg_version || '7.1' }}.tar.xz | tar xJ
          mv ffmpeg-* ffmpeg-src

      - name: Configure FFmpeg
        working-directory: ffmpeg-src
        run: |
          ./configure \
            --prefix=${{ github.workspace }}/ffmpeg-install \
            --enable-shared \
            --disable-static \
            --disable-programs \
            --disable-doc \
            --enable-gpl \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libopus \
            ${{ matrix.configure_flags }}

      - name: Build FFmpeg
        working-directory: ffmpeg-src
        run: make -j$(nproc || sysctl -n hw.ncpu)

      - name: Install FFmpeg
        working-directory: ffmpeg-src
        run: make install

      - name: Package libraries
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          cp -P ffmpeg-install/lib/*.{dylib,so}* ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          echo '{"ffmpeg": "${{ github.event.inputs.ffmpeg_version || '7.1' }}"}' > ffmpeg-${{ matrix.platform }}/versions.json

      - uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}
          retention-days: 7
