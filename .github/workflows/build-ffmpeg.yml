# FFmpeg Static Binary Build Workflow
# Based on GitHub Actions best practices for multi-platform native binary builds
#
# Key patterns applied:
# - Matrix strategy for parallel platform builds
# - Native runners (not QEMU emulation) for macOS arm64/x64
# - Docker buildx with GHA cache for Linux builds
# - Tar archives to preserve file permissions in artifacts
# - OIDC for npm publishing (no long-lived tokens)
# - Minimal GITHUB_TOKEN permissions per job
# - Pinned action versions for security
#
# Runner/Action versions updated: January 2026
# - macos-13 deprecated Dec 2025, using macos-15-intel for x64
# - macos-15 for ARM64 (macos-latest)
# - ubuntu-latest = Ubuntu 24.04
# - All actions on Node.js 24 (v5/v6 releases)

name: Build FFmpeg Static Binaries

on:
  push:
    tags:
      - 'v*'
      - 'deps-*'  # Also trigger on deps releases (e.g., deps-v1, deps-v2)
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version/branch to build'
        required: false
        default: 'master'
      skip_publish:
        description: 'Skip npm publish step'
        required: false
        type: boolean
        default: false
      deps_version:
        description: 'Create deps release with this version (e.g., v1, v2). Leave empty to skip deps release.'
        required: false
        type: string
        default: ''

# Default minimal permissions - override per job
permissions:
  contents: read

env:
  # Codec versions - update these for reproducible builds (Jan 2026)
  X264_VERSION: 'stable'
  X265_VERSION: '3.6'
  LIBVPX_VERSION: 'v1.15.2'
  LIBAOM_VERSION: 'v3.12.1'
  OPUS_VERSION: '1.5.2'
  LAME_VERSION: '3.100'
  FFMPEG_VERSION: 'n8.0'
  # SHA256 checksums for tarball downloads (hermetic build verification)
  # These MUST be updated when changing versions above
  # Sources: https://opus-codec.org/downloads/, https://sourceforge.net/projects/lame/
  # NASM uses GitHub source archive (more reliable than nasm.us)
  NASM_VERSION: '2.16.03'
  NASM_SHA256: 'e7f77b8247de72f3c2a2c57a9c72b2a0c847ec5e99ce6e68c1e225fa2e37c04c' # GitHub source archive
  OPUS_SHA256: '65c1d2f78b9f2fb20082c38cbe47c951ad5839345876e46941612ee87f9a7ce1'
  LAME_SHA256: 'ddfe36cab873794038ae2c1210557ad34857a4b6bdc515785d1da9e175b1da1e'
  # npm scope for platform packages
  NPM_SCOPE: '@pproenca/ffmpeg'
  # Bump this to invalidate all caches
  CACHE_VERSION: '11'
  # macOS deployment target - must match binding.gyp MACOSX_DEPLOYMENT_TARGET
  # This ensures ABI compatibility between FFmpeg libs and the native addon.
  # Using 11.0 (Big Sur) as minimum for widest compatibility.
  MACOS_DEPLOYMENT_TARGET: '11.0'

jobs:
  # ============================================================================
  # Linux x64 Build - Docker-based for musl static linking
  # ============================================================================
  build-linux-x64:
    name: Build Linux x64 (musl)
    runs-on: ubuntu-24.04  # Explicit version for reproducibility
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - run: npm install --ignore-scripts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build FFmpeg in Alpine container
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.linux-x64
          push: false
          load: true
          tags: ffmpeg-builder:linux-x64
          cache-from: type=gha,scope=linux-x64-v${{ env.CACHE_VERSION }}
          cache-to: type=gha,mode=max,scope=linux-x64-v${{ env.CACHE_VERSION }}

      - name: Extract binaries and dev files from container
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts extract-docker --image ffmpeg-builder:linux-x64 --container extract --platform linux-x64 --artifacts artifacts --ldd musl

      # Tar to preserve permissions (chmod +x is lost in artifact upload)
      - name: Package artifacts
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts package-artifacts --platform linux-x64 --artifacts artifacts

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-linux-x64
          path: artifacts/linux-x64.tar
          retention-days: 7
          compression-level: 0  # Already compressed, faster upload

  # ============================================================================
  # Linux x64 Build (glibc) - For native addon linking on Ubuntu/Debian
  # ============================================================================
  # The musl build above produces fully static binaries but its static libraries
  # cannot be linked into shared objects on glibc systems. This build produces
  # static libraries compatible with glibc for use by build-prebuilds.yml.
  # ============================================================================
  build-linux-x64-glibc:
    name: Build Linux x64 (glibc)
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - run: npm install --ignore-scripts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build FFmpeg in Ubuntu container
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.linux-x64-glibc
          push: false
          load: true
          tags: ffmpeg-builder:linux-x64-glibc
          cache-from: type=gha,scope=linux-x64-glibc-v${{ env.CACHE_VERSION }}
          cache-to: type=gha,mode=max,scope=linux-x64-glibc-v${{ env.CACHE_VERSION }}

      - name: Extract binaries and dev files from container
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts extract-docker --image ffmpeg-builder:linux-x64-glibc --container extract-glibc --platform linux-x64-glibc --artifacts artifacts --ldd glibc

      - name: Package artifacts
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts package-artifacts --platform linux-x64-glibc --artifacts artifacts

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-linux-x64-glibc
          path: artifacts/linux-x64-glibc.tar
          retention-days: 7
          compression-level: 0

  # ============================================================================
  # macOS Builds - Native runners for both architectures
  # ============================================================================
  build-macos:
    name: Build macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # macos-13 deprecated Dec 2025 - use macos-15-intel for x64
          # macos-15-intel available until Aug 2027 (last Intel runner)
          - runner: macos-15-intel
            arch: x64
            target: x86_64
          # macos-15 is ARM64 (same as macos-latest since Aug 2025)
          - runner: macos-15
            arch: arm64
            target: arm64

    env:
      TARGET: ${{ github.workspace }}/ffmpeg_build
      ARCH: ${{ matrix.target }}
      MACOSX_DEPLOYMENT_TARGET: '11.0'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - run: npm install --ignore-scripts

      - name: Install build dependencies
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts install-macos-deps

      - name: Cache compiled libraries
        uses: actions/cache@v5
        id: cache-libs
        with:
          path: |
            ${{ github.workspace }}/ffmpeg_build
            ${{ github.workspace }}/ffmpeg_sources
          # Include ALL library versions to ensure cache invalidates when any dependency changes
          key: macos-${{ matrix.arch }}-libs-${{ env.X264_VERSION }}-${{ env.X265_VERSION }}-${{ env.LIBVPX_VERSION }}-${{ env.LIBAOM_VERSION }}-${{ env.OPUS_VERSION }}-${{ env.LAME_VERSION }}-${{ env.MACOS_DEPLOYMENT_TARGET }}-v${{ env.CACHE_VERSION }}
          restore-keys: |
            macos-${{ matrix.arch }}-libs-

      - name: Build codec libraries
        if: steps.cache-libs.outputs.cache-hit != 'true'
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts build-macos-codecs

      - name: Build FFmpeg
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts build-macos-ffmpeg

      - name: Verify macOS deployment targets
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts verify-macos-abi

      - name: Verify and strip binaries
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts verify-strip

      - name: Package artifacts
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts package-macos --target "$TARGET" --arch "${{ matrix.arch }}" --artifacts artifacts

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-darwin-${{ matrix.arch }}
          path: artifacts/darwin-${{ matrix.arch }}.tar
          retention-days: 7
          compression-level: 0

  # ============================================================================
  # Package npm modules
  # ============================================================================
  package-npm:
    name: Package npm modules
    runs-on: ubuntu-24.04
    needs: [build-linux-x64, build-macos]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - run: npm install --ignore-scripts

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts

      - name: Extract and organize binaries
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts extract-package-npm --artifacts artifacts --packages packages

      - name: Create main package
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts create-main-package --packages packages

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v6
        with:
          name: npm-packages
          path: packages/
          retention-days: 7

  # ============================================================================
  # Publish to npm (only on tag push)
  # ============================================================================
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-24.04
    needs: [package-npm]
    if: startsWith(github.ref, 'refs/tags/v') && !inputs.skip_publish
    permissions:
      contents: read
      id-token: write  # Required for npm provenance

    environment:
      name: npm
      url: https://www.npmjs.com/package/${{ env.NPM_SCOPE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - run: npm install --ignore-scripts

      - name: Download npm packages
        uses: actions/download-artifact@v7
        with:
          name: npm-packages
          path: packages

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts publish-npm --packages packages

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: [build-linux-x64, build-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - run: npm install --ignore-scripts
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts

      - name: Prepare release assets
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts prepare-release-assets --artifacts artifacts --release release

      - name: Create Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## FFmpeg Static Binaries

            This release includes statically linked FFmpeg binaries for:
            - Linux x64 (musl libc, fully static)
            - macOS x64 (Intel)
            - macOS arm64 (Apple Silicon)

            ### Included Codecs
            - H.264 (libx264) - GPL
            - H.265/HEVC (libx265) - GPL
            - VP8/VP9 (libvpx) - BSD
            - AV1 (libaom) - BSD
            - Opus (libopus) - BSD
            - MP3 (libmp3lame) - LGPL

            ### npm Installation
            ```bash
            npm install ${{ env.NPM_SCOPE }}
            ```

            ### License
            These binaries are licensed under GPL v2+ due to the inclusion of libx264 and libx265.

  # ============================================================================
  # Create Dependencies Release (for CI/build-prebuilds consumption)
  # ============================================================================
  # This job creates the deps-vN release that ci.yml and build-prebuilds.yml
  # download FFmpeg binaries from. Files are named without version prefix:
  #   ffmpeg-linux-x64.tar.gz (not ffmpeg-v1.0.0-linux-x64.tar.gz)
  # ============================================================================
  release-deps:
    name: Create Dependencies Release
    runs-on: ubuntu-24.04
    needs: [build-linux-x64, build-linux-x64-glibc, build-macos]
    # Run if: manually triggered with deps_version input OR tag push matches deps-*
    if: inputs.deps_version != '' || startsWith(github.ref, 'refs/tags/deps-')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - run: npm install --ignore-scripts
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts

      - name: Determine deps version
        id: version
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts resolve-deps-version --input "${{ inputs.deps_version }}" --ref "${{ github.ref_name }}"

      - name: Prepare deps release assets
        run: npx tsx scripts/ci/build-ffmpeg-workflow.ts prepare-deps-assets --artifacts artifacts --release release

      - name: Create Dependencies Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: deps-${{ steps.version.outputs.version }}
          name: FFmpeg Dependencies ${{ steps.version.outputs.version }}
          files: release/*
          body: |
            ## FFmpeg Static Libraries for CI

            This release contains FFmpeg static binaries used by the CI and build pipelines.
            **Do not use directly** - these are consumed by `ci.yml` and `build-prebuilds.yml`.

            ### Files
            - `ffmpeg-linux-x64.tar.gz` - Linux x64 (musl, fully static binaries)
            - `ffmpeg-linux-x64-glibc.tar.gz` - Linux x64 (glibc, for native addon linking)
            - `ffmpeg-darwin-x64.tar.gz` - macOS Intel
            - `ffmpeg-darwin-arm64.tar.gz` - macOS Apple Silicon

            **Note:** `build-prebuilds.yml` uses `linux-x64-glibc` for native addon builds because
            musl-compiled static libraries cannot be linked into shared objects on glibc systems.

            ### Codec Versions
            - FFmpeg: ${{ env.FFMPEG_VERSION }}
            - x264: ${{ env.X264_VERSION }}
            - x265: ${{ env.X265_VERSION }}
            - libvpx: ${{ env.LIBVPX_VERSION }}
            - libaom: ${{ env.LIBAOM_VERSION }}
            - opus: ${{ env.OPUS_VERSION }}
            - lame: ${{ env.LAME_VERSION }}

            ### Usage
            Update `DEPS_VERSION` in `ci.yml` and `build-prebuilds.yml` to use this release:
            ```yaml
            env:
              DEPS_VERSION: ${{ steps.version.outputs.version }}
            ```
