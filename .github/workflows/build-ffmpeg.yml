name: build-ffmpeg

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: "FFmpeg version to build"
        default: "8.0.1"
      cache_version:
        description: "Cache version (bump to force rebuild)"
        default: "v3"
      force_rebuild:
        description: "Force rebuild (ignore cache)"
        type: boolean
        default: false
      upload_caches:
        description: "Upload caches as artifacts for debugging"
        type: boolean
        default: false
  workflow_call:
    inputs:
      ffmpeg_version:
        description: "FFmpeg version to build"
        type: string
        default: "8.0.1"
      cache_version:
        description: "Cache version (bump to force rebuild)"
        type: string
        default: "v3"
  push:
    paths:
      - ".github/workflows/build-ffmpeg.yml"
      - "ffmpeg/**"

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
      id-token: write
      attestations: write
    name: "ffmpeg-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    env:
      FFMPEG_VERSION: ${{ inputs.ffmpeg_version || '8.0.1' }}
      CACHE_VERSION: ${{ inputs.cache_version || 'v3' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin-arm64
            configure_flags: --enable-cross-compile --arch=arm64 --enable-videotoolbox --enable-audiotoolbox
          - os: macos-13
            platform: darwin-x64
            configure_flags: --enable-videotoolbox --enable-audiotoolbox
          - os: ubuntu-24.04
            platform: linux-x64
            configure_flags: ""
          - os: ubuntu-24.04
            platform: linuxmusl-x64
            container: alpine:${{ vars.ALPINE_VERSION || '3.19' }}
            configure_flags: ""

    steps:
      - uses: actions/checkout@v6

      # Cache FFmpeg build (skip for Alpine container - cache action doesn't work well there)
      - name: Restore FFmpeg cache
        if: ${{ !matrix.container && github.event.inputs.force_rebuild != 'true' }}
        id: cache-ffmpeg
        uses: actions/cache/restore@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ env.FFMPEG_VERSION }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            ffmpeg-${{ matrix.platform }}-${{ env.FFMPEG_VERSION }}-

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm pkg-config x264 x265 libvpx opus aom lame dav1d svt-av1 libvorbis
          HOMEBREW_PREFIX=$(brew --prefix)

          # Homebrew's lame doesn't include a pkg-config file, so we create one
          # FFmpeg checks for 'libmp3lame' not 'mp3lame'
          LAME_PREFIX="${HOMEBREW_PREFIX}/opt/lame"
          mkdir -p "${LAME_PREFIX}/lib/pkgconfig"
          printf 'prefix=%s\nexec_prefix=${prefix}\nlibdir=${prefix}/lib\nincludedir=${prefix}/include\n\nName: libmp3lame\nDescription: LAME MP3 encoder library\nVersion: 3.100\nLibs: -L${libdir} -lmp3lame\nCflags: -I${includedir}\n' "${LAME_PREFIX}" > "${LAME_PREFIX}/lib/pkgconfig/libmp3lame.pc"

          # Set PKG_CONFIG_PATH for Homebrew (ARM64: /opt/homebrew, Intel: /usr/local)
          echo "PKG_CONFIG_PATH=${HOMEBREW_PREFIX}/lib/pkgconfig:${LAME_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV

          # Verify lame is now findable
          export PKG_CONFIG_PATH="${HOMEBREW_PREFIX}/lib/pkgconfig:${LAME_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}"
          echo "Created libmp3lame.pc at ${LAME_PREFIX}/lib/pkgconfig/"
          cat "${LAME_PREFIX}/lib/pkgconfig/libmp3lame.pc"
          pkg-config --modversion libmp3lame
          pkg-config --libs libmp3lame

      - name: Install dependencies (Linux glibc)
        if: runner.os == 'Linux' && !matrix.container
        run: |
          sudo apt-get update
          # Note: libsvtav1enc-dev (not libsvtav1-dev) contains the pkg-config file
          sudo apt-get install -y nasm yasm pkg-config \
            libx264-dev libx265-dev libvpx-dev libopus-dev libaom-dev libmp3lame-dev \
            libdav1d-dev libsvtav1enc-dev libvorbis-dev
          # Verify SVT-AV1 is available
          pkg-config --modversion SvtAv1Enc

      - name: Install dependencies (Linux musl)
        if: matrix.container
        run: |
          apk add --no-cache build-base nasm yasm pkgconf curl \
            x264-dev x265-dev libvpx-dev opus-dev aom-dev lame-dev \
            dav1d-dev svt-av1-dev libvorbis-dev

      - name: Download FFmpeg source
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          curl -L https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz | tar xJ
          mv ffmpeg-${{ env.FFMPEG_VERSION }} ffmpeg-src

      - name: Check codec availability
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        id: codec-check
        run: |
          # Check if SVT-AV1 is available and working
          if pkg-config --exists "SvtAv1Enc >= 0.9.0" 2>/dev/null; then
            echo "svtav1=--enable-libsvtav1" >> $GITHUB_OUTPUT
            echo "SVT-AV1 available: $(pkg-config --modversion SvtAv1Enc)"
          else
            echo "svtav1=" >> $GITHUB_OUTPUT
            echo "SVT-AV1 not available or version too old, disabling"
            pkg-config --modversion SvtAv1Enc 2>/dev/null || echo "  (pkg-config check failed)"
          fi

      - name: Configure FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        working-directory: ffmpeg-src
        run: |
          ./configure \
            --prefix=${{ github.workspace }}/ffmpeg-install \
            --enable-shared \
            --disable-static \
            --disable-programs \
            --disable-doc \
            --enable-gpl \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libopus \
            --enable-libaom \
            --enable-libmp3lame \
            --enable-libdav1d \
            ${{ steps.codec-check.outputs.svtav1 }} \
            --enable-libvorbis \
            ${{ matrix.configure_flags }}

      - name: Build FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        working-directory: ffmpeg-src
        run: make -j$(nproc || sysctl -n hw.ncpu)

      - name: Install FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        working-directory: ffmpeg-src
        run: make install

      - name: Save FFmpeg cache
        if: ${{ !matrix.container && steps.cache-ffmpeg.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ env.FFMPEG_VERSION }}-${{ env.CACHE_VERSION }}

      - name: Upload cache as artifact (debug)
        if: ${{ github.event.inputs.upload_caches == 'true' }}
        uses: actions/upload-artifact@v6
        with:
          name: cache-ffmpeg-${{ matrix.platform }}
          path: ffmpeg-install
          retention-days: 3

      - name: Package libraries and headers
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          mkdir -p ffmpeg-${{ matrix.platform }}/include
          # Copy libraries (macOS uses .dylib, Linux uses .so)
          cp -P ffmpeg-install/lib/*.dylib ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          cp -P ffmpeg-install/lib/*.so* ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          # Copy pkgconfig files (needed for compilation against this FFmpeg)
          cp -r ffmpeg-install/lib/pkgconfig ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          # Copy headers (use cp -r on directory itself to avoid glob issues on Alpine)
          cp -r ffmpeg-install/include/. ffmpeg-${{ matrix.platform }}/include/
          echo '{"ffmpeg": "${{ env.FFMPEG_VERSION }}"}' > ffmpeg-${{ matrix.platform }}/versions.json

      - uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}
          retention-days: 7

      - name: Attest FFmpeg artifact
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-${{ matrix.platform }}/**/*
