name: Build FFmpeg

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version to build'
        required: true
        default: '7.1'
  push:
    paths:
      - '.github/workflows/build-ffmpeg.yml'
      - 'ffmpeg/**'

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
    name: "ffmpeg-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin-arm64
            configure_flags: --enable-cross-compile --arch=arm64
          - os: macos-15-intel
            platform: darwin-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linux-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linuxmusl-x64
            container: alpine:3.19
            configure_flags: ""
          # Windows build disabled - requires MSYS2 + MSVC toolchain setup
          # See: https://trac.ffmpeg.org/wiki/CompilationGuide/MSVC
          # - os: windows-2022
          #   platform: win32-x64
          #   configure_flags: --toolchain=msvc

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm pkg-config x264 x265 libvpx opus

      - name: Install dependencies (Linux glibc)
        if: runner.os == 'Linux' && !matrix.container
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config \
            libx264-dev libx265-dev libvpx-dev libopus-dev

      - name: Install dependencies (Linux musl)
        if: matrix.container == 'alpine:3.19'
        run: |
          apk add --no-cache build-base nasm yasm pkgconf curl \
            x264-dev x265-dev libvpx-dev opus-dev

      - name: Download FFmpeg source (Unix)
        if: runner.os != 'Windows'
        run: |
          curl -L https://ffmpeg.org/releases/ffmpeg-${{ github.event.inputs.ffmpeg_version || '7.1' }}.tar.xz | tar xJ
          mv ffmpeg-* ffmpeg-src

      - name: Download FFmpeg source (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.ffmpeg_version || '7.1' }}"
          Invoke-WebRequest -Uri "https://ffmpeg.org/releases/ffmpeg-$version.tar.xz" -OutFile "ffmpeg.tar.xz"
          7z x ffmpeg.tar.xz -so | 7z x -si -ttar
          Move-Item ffmpeg-* ffmpeg-src

      - name: Configure FFmpeg
        working-directory: ffmpeg-src
        run: |
          ./configure \
            --prefix=${{ github.workspace }}/ffmpeg-install \
            --enable-shared \
            --disable-static \
            --disable-programs \
            --disable-doc \
            --enable-gpl \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libopus \
            ${{ matrix.configure_flags }}

      - name: Build FFmpeg
        working-directory: ffmpeg-src
        run: make -j$(nproc || sysctl -n hw.ncpu)

      - name: Install FFmpeg
        working-directory: ffmpeg-src
        run: make install

      - name: Package libraries (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          cp -P ffmpeg-install/lib/*.{dylib,so}* ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          # Create versions.json
          echo '{"ffmpeg": "${{ github.event.inputs.ffmpeg_version || '7.1' }}"}' > ffmpeg-${{ matrix.platform }}/versions.json

      - name: Package libraries (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          cp ffmpeg-install/bin/*.dll ffmpeg-${{ matrix.platform }}/lib/
          echo '{"ffmpeg": "${{ github.event.inputs.ffmpeg_version || '7.1' }}"}' > ffmpeg-${{ matrix.platform }}/versions.json

      - uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}
          retention-days: 7
