name: build-ffmpeg

# This workflow builds FFmpeg and creates a GitHub Release with pre-built binaries.
# Run manually via workflow_dispatch when FFmpeg needs to be updated.
# Other workflows download FFmpeg from the deps-vN release.

on:
  workflow_dispatch:
    inputs:
      deps_version:
        description: "Dependencies version tag (e.g., v1, v2)"
        required: true
        default: "v1"
      force_rebuild:
        description: "Force rebuild (ignore cache)"
        type: boolean
        default: false

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
      id-token: write
      attestations: write
    name: "ffmpeg-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    env:
      CACHE_VERSION: ${{ inputs.deps_version || 'v1' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin-arm64
            arch: arm64
          - os: macos-15-intel
            platform: darwin-x64
            arch: x86_64
          - os: ubuntu-24.04
            platform: linux-x64
            target: linux64

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Get jellyfin-ffmpeg commit hash
        id: ffmpeg-hash
        run: |
          cd externals/jellyfin-ffmpeg
          echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "FFmpeg commit: $(git rev-parse --short HEAD)"

      - name: Restore FFmpeg cache
        if: ${{ github.event.inputs.force_rebuild != 'true' }}
        id: cache-ffmpeg
        uses: actions/cache/restore@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ steps.ffmpeg-hash.outputs.hash }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            ffmpeg-${{ matrix.platform }}-${{ steps.ffmpeg-hash.outputs.hash }}-
            ffmpeg-${{ matrix.platform }}-

      - name: Log cache status
        run: |
          echo "::group::Cache Diagnostics"
          echo "Cache hit: ${{ steps.cache-ffmpeg.outputs.cache-hit }}"
          echo "Cache key: ffmpeg-${{ matrix.platform }}-${{ steps.ffmpeg-hash.outputs.hash }}-${{ env.CACHE_VERSION }}"
          echo "FFmpeg hash: ${{ steps.ffmpeg-hash.outputs.hash }}"
          echo "Cache version: ${{ env.CACHE_VERSION }}"
          if [[ "${{ steps.cache-ffmpeg.outputs.cache-hit }}" == "true" ]]; then
            echo "✓ Cache HIT - skipping build"
          else
            echo "⚠ Cache MISS - will rebuild FFmpeg"
          fi
          echo "::endgroup::"

      - name: Fix macOS 15 PerfPowerServices CPU bug
        if: runner.os == 'macOS'
        run: |
          # Workaround for known macOS 15 bug where PerfPowerServices consumes 100% CPU
          # See: https://github.com/actions/runner-images/issues/13358
          sudo defaults -currentHost write /Library/Preferences/com.apple.powerlogd SMCMonitorCadence 0
          sudo killall PerfPowerServices || true

      # =========================================================================
      # macOS Build using jellyfin-ffmpeg builder
      # =========================================================================
      - name: Cache Homebrew packages
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        uses: actions/cache@v5
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
            /opt/homebrew/opt
            /usr/local/Cellar
            /usr/local/opt
          key: brew-ffmpeg-${{ runner.arch }}-v1
          restore-keys: |
            brew-ffmpeg-${{ runner.arch }}-

      - name: Install build tools (macOS)
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          # Install dependencies as listed in jellyfin-ffmpeg/builder/Buildmac.md
          # Only install packages not already present (from cache)
          PACKAGES="nasm pkg-config autoconf automake libtool cmake meson ninja quilt"
          MISSING=""
          for pkg in $PACKAGES; do
            if ! brew list "$pkg" &>/dev/null; then
              MISSING="$MISSING $pkg"
            fi
          done
          if [[ -n "$MISSING" ]]; then
            echo "Installing missing packages:$MISSING"
            brew install $MISSING
          else
            echo "All packages already installed (from cache)"
          fi

      - name: Prepare FFmpeg prefix (macOS)
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          # Create the prefix directory where dependencies will be installed
          sudo mkdir -p /opt/ffbuild/prefix
          sudo chown -R $(whoami) /opt/ffbuild

      - name: Build FFmpeg (macOS)
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          cd externals/jellyfin-ffmpeg/builder
          echo "=== Building jellyfin-ffmpeg for macOS ${{ matrix.arch }} ==="
          ./buildmac.sh ${{ matrix.arch }}

          # Verify config files were generated (following node-av pattern)
          cd ..
          if [ ! -f config.h ]; then
            echo "::error::config.h not found after FFmpeg build"
            exit 1
          fi
          if [ ! -f config_components.h ]; then
            echo "::error::config_components.h not found after FFmpeg build"
            exit 1
          fi
          echo "Config files verified"

          # Install FFmpeg libraries to prefix (buildmac.sh only builds, doesn't install)
          make install prefix=/opt/ffbuild/prefix

          # Copy to workspace for caching
          cp -r /opt/ffbuild/prefix ${{ github.workspace }}/ffmpeg-install

          # Also copy config files to install dir for reference
          cp config.h config_components.h ${{ github.workspace }}/ffmpeg-install/

      # =========================================================================
      # Linux Build using jellyfin-ffmpeg Docker builder
      # =========================================================================
      - name: Build FFmpeg (Linux)
        if: runner.os == 'Linux' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clear /opt/ffbuild to avoid conflicts with stale data (following node-av pattern)
          sudo rm -rf /opt/ffbuild
          sudo mkdir -p /opt/ffbuild/prefix
          sudo chown -R $USER:$USER /opt/ffbuild
          sudo chmod -R 755 /opt/ffbuild

          cd externals/jellyfin-ffmpeg/builder
          echo "=== Building jellyfin-ffmpeg for Linux ${{ matrix.target }} ==="

          # Pre-pull the Docker image - fail fast if missing
          IMAGE="ghcr.io/${{ github.repository_owner }}/jellyfin-ffmpeg/${{ matrix.target }}-gpl:latest"

          echo "::group::Docker Image Pull"
          if ! docker pull "${IMAGE}"; then
            echo "::error::Docker image not found: ${IMAGE}"
            echo "::error::Run the build-docker-images workflow first, or check GHCR permissions"
            exit 1
          fi
          echo "✓ Using pre-built Docker image: ${IMAGE}"
          echo "::endgroup::"

          # Override GITHUB_REPOSITORY to use repository owner's images
          # Must export inside script - GitHub Actions injects its own value that takes precedence over env: block
          export GITHUB_REPOSITORY="${{ github.repository_owner }}/jellyfin-ffmpeg"

          # Build FFmpeg using Docker (includes make install)
          ./build.sh ${{ matrix.target }} gpl

          # Verify build output exists
          if [ ! -d ffbuild/prefix/lib ]; then
            echo "::error::FFmpeg build failed - no lib directory in ffbuild/prefix"
            exit 1
          fi

          # Copy build output to workspace
          mkdir -p ${{ github.workspace }}/ffmpeg-install
          cp -r ffbuild/prefix/* ${{ github.workspace }}/ffmpeg-install/

          # Copy config files from Docker build if available
          if [ -f ffbuild/ffmpeg/config.h ]; then
            cp ffbuild/ffmpeg/config.h ffbuild/ffmpeg/config_components.h ${{ github.workspace }}/ffmpeg-install/ 2>/dev/null || true
          fi

      # =========================================================================
      # Cache and Package
      # =========================================================================
      - name: Save FFmpeg cache
        if: ${{ steps.cache-ffmpeg.outputs.cache-hit != 'true' && success() }}
        uses: actions/cache/save@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ steps.ffmpeg-hash.outputs.hash }}-${{ env.CACHE_VERSION }}

      - name: Verify build output
        if: success()
        run: |
          echo "=== FFmpeg installation contents ==="
          ls -la ffmpeg-install/
          echo "=== Libraries ==="
          ls -la ffmpeg-install/lib/ || echo "No lib directory"
          echo "=== Static libraries ==="
          ls -la ffmpeg-install/lib/*.a 2>/dev/null || echo "No static libraries found"
          echo "=== Headers ==="
          ls ffmpeg-install/include/ || echo "No include directory"

      - name: Package libraries and headers
        if: success()
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          mkdir -p ffmpeg-${{ matrix.platform }}/include

          # Copy static libraries
          if ls ffmpeg-install/lib/*.a 1> /dev/null 2>&1; then
            cp ffmpeg-install/lib/*.a ffmpeg-${{ matrix.platform }}/lib/
          fi

          # Copy pkgconfig files
          if [ -d ffmpeg-install/lib/pkgconfig ]; then
            cp -r ffmpeg-install/lib/pkgconfig ffmpeg-${{ matrix.platform }}/lib/
          fi

          # Copy headers
          if [ -d ffmpeg-install/include ]; then
            cp -r ffmpeg-install/include/* ffmpeg-${{ matrix.platform }}/include/
          fi

          # Create version metadata
          echo '{"source": "jellyfin-ffmpeg", "commit": "${{ steps.ffmpeg-hash.outputs.hash }}"}' > ffmpeg-${{ matrix.platform }}/versions.json

          echo "=== Final package contents ==="
          ls -la ffmpeg-${{ matrix.platform }}/lib/

      - uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}
          retention-days: 7

      - name: Attest FFmpeg artifact
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-${{ matrix.platform }}/**/*

  create-release:
    name: "Create Dependencies Release"
    needs: [build-ffmpeg]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all FFmpeg artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-*
          path: deps

      - name: Package for release
        run: |
          mkdir -p release
          for platform in darwin-arm64 darwin-x64 linux-x64; do
            if [ -d "deps/ffmpeg-$platform" ]; then
              tar -czvf "release/ffmpeg-$platform.tar.gz" -C "deps/ffmpeg-$platform" .
              echo "Created ffmpeg-$platform.tar.gz"
            fi
          done
          ls -la release/

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: deps-${{ inputs.deps_version }}
          name: "FFmpeg Dependencies ${{ inputs.deps_version }}"
          body: |
            Pre-built static FFmpeg libraries for node-webcodecs.

            **Source:** jellyfin-ffmpeg (commit from submodule)
            **Platforms:** darwin-arm64, darwin-x64, linux-x64

            Download the appropriate `.tar.gz` for your platform and extract to `ffmpeg-install/`.
          files: release/*.tar.gz
          fail_on_unmatched_files: true
          make_latest: true
