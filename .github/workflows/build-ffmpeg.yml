name: Build FFmpeg

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: "FFmpeg version to build"
        required: true
        default: "7.1"
      publish:
        description: "Publish to npm after build"
        type: boolean
        default: false
  push:
    paths:
      - ".github/workflows/build-ffmpeg.yml"
      - "ffmpeg/**"

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
    name: "ffmpeg-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin-arm64
            configure_flags: --enable-cross-compile --arch=arm64
          - os: macos-13
            platform: darwin-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linux-x64
            configure_flags: ""
          - os: ubuntu-22.04
            platform: linuxmusl-x64
            container: alpine:3.19
            configure_flags: ""

    steps:
      - uses: actions/checkout@v5

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm pkg-config x264 x265 libvpx opus aom

      - name: Install dependencies (Linux glibc)
        if: runner.os == 'Linux' && !matrix.container
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config \
            libx264-dev libx265-dev libvpx-dev libopus-dev libaom-dev

      - name: Install dependencies (Linux musl)
        if: matrix.container == 'alpine:3.19'
        run: |
          apk add --no-cache build-base nasm yasm pkgconf curl \
            x264-dev x265-dev libvpx-dev opus-dev aom-dev

      - name: Download FFmpeg source
        run: |
          curl -L https://ffmpeg.org/releases/ffmpeg-${{ github.event.inputs.ffmpeg_version || '7.1' }}.tar.xz | tar xJ
          mv ffmpeg-* ffmpeg-src

      - name: Configure FFmpeg
        working-directory: ffmpeg-src
        run: |
          ./configure \
            --prefix=${{ github.workspace }}/ffmpeg-install \
            --enable-shared \
            --disable-static \
            --disable-programs \
            --disable-doc \
            --enable-gpl \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libopus \
            --enable-libaom \
            ${{ matrix.configure_flags }}

      - name: Build FFmpeg
        working-directory: ffmpeg-src
        run: make -j$(nproc || sysctl -n hw.ncpu)

      - name: Install FFmpeg
        working-directory: ffmpeg-src
        run: make install

      - name: Package libraries and headers
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          mkdir -p ffmpeg-${{ matrix.platform }}/include
          cp -P ffmpeg-install/lib/*.{dylib,so}* ffmpeg-${{ matrix.platform }}/lib/ 2>/dev/null || true
          cp -r ffmpeg-install/include/* ffmpeg-${{ matrix.platform }}/include/
          echo '{"ffmpeg": "${{ github.event.inputs.ffmpeg_version || '7.1' }}"}' > ffmpeg-${{ matrix.platform }}/versions.json

      - uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}
          retention-days: 7

  publish:
    if: github.event.inputs.publish == 'true'
    needs: build-ffmpeg
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        platform: [darwin-arm64, darwin-x64, linux-x64, linuxmusl-x64]
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          registry-url: "https://registry.npmjs.org"

      - uses: actions/download-artifact@v4
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}

      - name: Populate package
        run: |
          FFMPEG_ARTIFACT_DIR=${{ github.workspace }}/ffmpeg-${{ matrix.platform }} \
            node ffmpeg/from-ci-build.js ${{ matrix.platform }}

      - name: Publish to npm
        working-directory: ffmpeg/${{ matrix.platform }}
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
