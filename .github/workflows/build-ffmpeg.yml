name: build-ffmpeg

# Note: No concurrency block here - this workflow is called by ci.yml and
# build-prebuilds.yml which have their own concurrency controls.

on:
  workflow_dispatch:
    inputs:
      cache_version:
        description: "Cache version (bump to force rebuild)"
        default: "v1"
      force_rebuild:
        description: "Force rebuild (ignore cache)"
        type: boolean
        default: false
  workflow_call:
    inputs:
      cache_version:
        description: "Cache version (bump to force rebuild)"
        type: string
        default: "v1"
  push:
    paths:
      - ".github/workflows/build-ffmpeg.yml"
      - "externals/jellyfin-ffmpeg/**"
  pull_request:
    paths:
      - ".github/workflows/build-ffmpeg.yml"
      - "externals/jellyfin-ffmpeg/**"

permissions: {}

jobs:
  build-ffmpeg:
    permissions:
      contents: read
      id-token: write
      attestations: write
    name: "ffmpeg-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    env:
      CACHE_VERSION: ${{ inputs.cache_version || 'v1' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin-arm64
            arch: arm64
          - os: macos-15-intel
            platform: darwin-x64
            arch: x86_64
          - os: ubuntu-24.04
            platform: linux-x64
            target: linux64

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Get jellyfin-ffmpeg commit hash
        id: ffmpeg-hash
        run: |
          cd externals/jellyfin-ffmpeg
          echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "FFmpeg commit: $(git rev-parse --short HEAD)"

      - name: Restore FFmpeg cache
        if: ${{ github.event.inputs.force_rebuild != 'true' }}
        id: cache-ffmpeg
        uses: actions/cache/restore@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ steps.ffmpeg-hash.outputs.hash }}-${{ env.CACHE_VERSION }}

      - name: Fix macOS 15 PerfPowerServices CPU bug
        if: runner.os == 'macOS'
        run: |
          # Workaround for known macOS 15 bug where PerfPowerServices consumes 100% CPU
          # See: https://github.com/actions/runner-images/issues/13358
          sudo defaults -currentHost write /Library/Preferences/com.apple.powerlogd SMCMonitorCadence 0
          sudo killall PerfPowerServices || true

      # =========================================================================
      # macOS Build using jellyfin-ffmpeg builder
      # =========================================================================
      - name: Install build tools (macOS)
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          # Install dependencies as listed in jellyfin-ffmpeg/builder/Buildmac.md
          brew install nasm pkg-config autoconf automake libtool cmake meson ninja quilt

      - name: Prepare FFmpeg prefix (macOS)
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          # Create the prefix directory where dependencies will be installed
          sudo mkdir -p /opt/ffbuild/prefix
          sudo chown -R $(whoami) /opt/ffbuild

      - name: Build FFmpeg (macOS)
        if: runner.os == 'macOS' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          cd externals/jellyfin-ffmpeg/builder
          echo "=== Building jellyfin-ffmpeg for macOS ${{ matrix.arch }} ==="
          ./buildmac.sh ${{ matrix.arch }}

          # Verify config files were generated (following node-av pattern)
          cd ..
          if [ ! -f config.h ]; then
            echo "::error::config.h not found after FFmpeg build"
            exit 1
          fi
          if [ ! -f config_components.h ]; then
            echo "::error::config_components.h not found after FFmpeg build"
            exit 1
          fi
          echo "Config files verified"

          # Install FFmpeg libraries to prefix (buildmac.sh only builds, doesn't install)
          make install prefix=/opt/ffbuild/prefix

          # Copy to workspace for caching
          cp -r /opt/ffbuild/prefix ${{ github.workspace }}/ffmpeg-install

          # Also copy config files to install dir for reference
          cp config.h config_components.h ${{ github.workspace }}/ffmpeg-install/

      # =========================================================================
      # Linux Build using jellyfin-ffmpeg Docker builder
      # =========================================================================
      - name: Build FFmpeg (Linux)
        if: runner.os == 'Linux' && steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          # Override GITHUB_REPOSITORY to use seydx's pre-built Docker images
          # Must export inside script - GitHub Actions injects its own value that takes precedence over env: block
          export GITHUB_REPOSITORY="seydx/jellyfin-ffmpeg"

          cd externals/jellyfin-ffmpeg/builder
          echo "=== Building jellyfin-ffmpeg for Linux ${{ matrix.target }} ==="
          echo "Using Docker images from: ghcr.io/${GITHUB_REPOSITORY}"

          # Build using Docker (includes make install)
          ./build.sh ${{ matrix.target }} gpl

          # Verify build output exists
          if [ ! -d ffbuild/prefix/lib ]; then
            echo "::error::FFmpeg build failed - no lib directory in ffbuild/prefix"
            exit 1
          fi

          # Copy build output to workspace
          mkdir -p ${{ github.workspace }}/ffmpeg-install
          cp -r ffbuild/prefix/* ${{ github.workspace }}/ffmpeg-install/

          # Copy config files from Docker build if available
          if [ -f ffbuild/ffmpeg/config.h ]; then
            cp ffbuild/ffmpeg/config.h ffbuild/ffmpeg/config_components.h ${{ github.workspace }}/ffmpeg-install/ 2>/dev/null || true
          fi

      # =========================================================================
      # Cache and Package
      # =========================================================================
      - name: Save FFmpeg cache
        if: ${{ steps.cache-ffmpeg.outputs.cache-hit != 'true' && success() }}
        uses: actions/cache/save@v5
        with:
          path: ffmpeg-install
          key: ffmpeg-${{ matrix.platform }}-${{ steps.ffmpeg-hash.outputs.hash }}-${{ env.CACHE_VERSION }}

      - name: Verify build output
        if: success()
        run: |
          echo "=== FFmpeg installation contents ==="
          ls -la ffmpeg-install/
          echo "=== Libraries ==="
          ls -la ffmpeg-install/lib/ || echo "No lib directory"
          echo "=== Static libraries ==="
          ls -la ffmpeg-install/lib/*.a 2>/dev/null || echo "No static libraries found"
          echo "=== Headers ==="
          ls ffmpeg-install/include/ || echo "No include directory"

      - name: Package libraries and headers
        if: success()
        run: |
          mkdir -p ffmpeg-${{ matrix.platform }}/lib
          mkdir -p ffmpeg-${{ matrix.platform }}/include

          # Copy static libraries
          if ls ffmpeg-install/lib/*.a 1> /dev/null 2>&1; then
            cp ffmpeg-install/lib/*.a ffmpeg-${{ matrix.platform }}/lib/
          fi

          # Copy pkgconfig files
          if [ -d ffmpeg-install/lib/pkgconfig ]; then
            cp -r ffmpeg-install/lib/pkgconfig ffmpeg-${{ matrix.platform }}/lib/
          fi

          # Copy headers
          if [ -d ffmpeg-install/include ]; then
            cp -r ffmpeg-install/include/* ffmpeg-${{ matrix.platform }}/include/
          fi

          # Create version metadata
          echo '{"source": "jellyfin-ffmpeg", "commit": "${{ steps.ffmpeg-hash.outputs.hash }}"}' > ffmpeg-${{ matrix.platform }}/versions.json

          echo "=== Final package contents ==="
          ls -la ffmpeg-${{ matrix.platform }}/lib/

      - uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: ffmpeg-${{ matrix.platform }}
          retention-days: 7

      - name: Attest FFmpeg artifact
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-${{ matrix.platform }}/**/*
