name: ci

# Concurrency: Cancel in-progress PR runs, but let master commits complete independently
# (each master commit should be validated for bisect/audit purposes)
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

on:
  workflow_dispatch:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions: {}

# DEPS_VERSION is resolved dynamically in the resolve-deps job
# No hardcoded version here - always uses latest deps-* release

jobs:
  # ============================================================================
  # Resolve latest FFmpeg dependencies release
  # This eliminates the need to manually bump DEPS_VERSION
  # ============================================================================
  resolve-deps:
    name: "Resolve Dependencies"
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      deps_version: ${{ steps.deps.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "22"
      - run: npm install --ignore-scripts
      - name: Find latest deps release
        id: deps
        env:
          GH_TOKEN: ${{ github.token }}
        run: npx tsx scripts/ci/ci-workflow.ts resolve-deps --repo "${{ github.repository }}"


  # ============================================================================
  # Lint - Fast fail on code quality issues
  # ============================================================================
  lint:
    permissions:
      contents: read
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "22"
      - run: npm install --ignore-scripts
      - run: npm run build:ts
      - run: npm run lint

  # ============================================================================
  # C++ Native Tests - Sanitizers and Coverage
  # Validates memory safety, thread safety, and W3C spec compliance
  # ============================================================================
  test-native:
    permissions:
      contents: read
    needs: [lint, resolve-deps]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            lcov

      - name: Download FFmpeg from Release
        uses: dsaltares/fetch-gh-release-asset@aa2ab1243d6e0d5b405b973c89fa4d06a2d0fff7 # v1.1.2
        with:
          repo: ${{ github.repository }}
          version: tags/deps-${{ needs.resolve-deps.outputs.deps_version }}
          file: ffmpeg-linux-x64-glibc.tar.gz
          target: ffmpeg-linux-x64.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract FFmpeg and Set Environment
        run: npx tsx scripts/ci/ci-workflow.ts extract-ffmpeg --archive "ffmpeg-linux-x64.tar.gz" --out ffmpeg-install

      - name: Build and test with sanitizers
        run: |
          cd test/native
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DSANITIZE=ON
          make -j$(nproc)
          ASAN_OPTIONS=detect_leaks=1 ./webcodecs_tests --gtest_output=xml:test_results.xml --gtest_brief=1

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: native-test-results
          path: test/native/build/test_results.xml
          retention-days: 7

      - name: Build and test with ThreadSanitizer
        run: |
          cd test/native/build
          rm -rf *
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DTSAN=ON
          make -j$(nproc)
          TSAN_OPTIONS=halt_on_error=1 ./webcodecs_tests --gtest_brief=1

      - name: Generate coverage report
        run: |
          cd test/native/build
          rm -rf *
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DCOVERAGE=ON
          make -j$(nproc)
          ./webcodecs_tests
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '*/googletest/*' --output-file coverage.info
          lcov --list coverage.info

      - name: Upload coverage to artifact
        uses: actions/upload-artifact@v6
        with:
          name: native-coverage
          path: test/native/build/coverage.info
          retention-days: 7

  # ============================================================================
  # Build native addon for each platform (single Node version)
  # Produces release-ready artifacts that are tested across Node versions
  # ============================================================================
  build-native:
    permissions:
      contents: read
      id-token: write # For OIDC attestation
      attestations: write # For build provenance
    needs: [lint, resolve-deps]
    name: "build-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x64-glibc
            arch: x64
            libc: glibc
          - os: ubuntu-24.04
            platform: linux-x64-musl
            arch: x64
            libc: musl
            container: node:22-alpine
          - os: macos-15-intel
            platform: darwin-x64
            arch: x64
          - os: macos-15
            platform: darwin-arm64
            arch: arm64

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Fix macOS 15 PerfPowerServices CPU bug
        if: runner.os == 'macOS'
        run: npx tsx scripts/ci/ci-workflow.ts fix-macos-power

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: npx tsx scripts/ci/ci-workflow.ts install-build-tools --os macos

      - name: Install build tools (Ubuntu)
        if: runner.os == 'Linux'
        run: npx tsx scripts/ci/ci-workflow.ts install-build-tools --os linux

      # Try npm packages first (faster, no GitHub API rate limits)
      # Falls back to GitHub releases if package doesn't exist yet
      - name: Resolve FFmpeg source
        id: ffmpeg-source
        run: |
          # Determine npm package name based on platform
          if [[ "${{ matrix.platform }}" == "linux-x64-musl" ]]; then
            NPM_PKG="@pproenca/ffmpeg-dev-linux-x64-musl"
          else
            NPM_PKG="@pproenca/ffmpeg-dev-${{ matrix.platform }}"
          fi

          echo "npm_package=$NPM_PKG" >> "$GITHUB_OUTPUT"

          # Check if npm package exists
          if npm view "$NPM_PKG" version > /dev/null 2>&1; then
            echo "source=npm" >> "$GITHUB_OUTPUT"
            echo "✓ FFmpeg available from npm: $NPM_PKG"
          else
            echo "source=github-release" >> "$GITHUB_OUTPUT"
            echo "⚠ FFmpeg npm package not found, using GitHub releases"
          fi

      - name: Install FFmpeg from npm
        if: steps.ffmpeg-source.outputs.source == 'npm'
        run: |
          echo "Installing ${{ steps.ffmpeg-source.outputs.npm_package }}..."
          npm install --no-save ${{ steps.ffmpeg-source.outputs.npm_package }}

          # Set FFMPEG_ROOT for gyp/ffmpeg-paths.js
          FFMPEG_ROOT="$(npm root)/${{ steps.ffmpeg-source.outputs.npm_package }}"
          echo "FFMPEG_ROOT=$FFMPEG_ROOT" >> "$GITHUB_ENV"

          echo "✓ FFmpeg installed from npm"
          echo "FFMPEG_ROOT=$FFMPEG_ROOT"

          # Verify installation
          ls -lh "$FFMPEG_ROOT/lib/" | head -5

      - name: Download FFmpeg from GitHub Release (fallback)
        if: steps.ffmpeg-source.outputs.source == 'github-release'
        uses: dsaltares/fetch-gh-release-asset@aa2ab1243d6e0d5b405b973c89fa4d06a2d0fff7 # v1.1.2
        with:
          repo: ${{ github.repository }}
          version: tags/deps-${{ needs.resolve-deps.outputs.deps_version }}
          # Map platform to FFmpeg asset name:
          # - linux-x64-musl → ffmpeg-linux-x64.tar.gz (musl build)
          # - linux-x64-glibc → ffmpeg-linux-x64-glibc.tar.gz
          # - darwin-* → ffmpeg-darwin-*.tar.gz
          file: ffmpeg-${{ matrix.platform == 'linux-x64-musl' && 'linux-x64' || matrix.platform }}.tar.gz
          target: ffmpeg-${{ matrix.platform }}.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract FFmpeg from GitHub Release (fallback)
        if: steps.ffmpeg-source.outputs.source == 'github-release'
        run: npx tsx scripts/ci/ci-workflow.ts extract-ffmpeg --archive "ffmpeg-${{ matrix.platform }}.tar.gz" --out ffmpeg-install

      - name: Build with prebuildify
        run: npx tsx scripts/ci/ci-workflow.ts prebuildify --arch "${{ matrix.arch }}" --platform "${{ matrix.platform }}"${{ matrix.libc && format(' --libc {0}', matrix.libc) || '' }}

      - name: Build TypeScript
        run: npm run build:ts

      - name: Run Tests (verify build works)
        run: npm run test:fast

      - name: Package as platform npm package
        env:
          PLATFORM: ${{ matrix.platform }}
          PLATFORM_OS: ${{ runner.os == 'macOS' && 'darwin' || 'linux' }}
          PLATFORM_CPU: ${{ matrix.arch }}
        run: npx tsx scripts/ci/ci-workflow.ts package-platform --platform "$PLATFORM" --os "$PLATFORM_OS" --cpu "$PLATFORM_CPU" --prebuild "prebuilds/${{ matrix.platform }}/node.napi.node" --out packages${{ matrix.libc && format(' --libc {0}', matrix.libc) || '' }}

      - name: Upload platform package artifact
        uses: actions/upload-artifact@v6
        with:
          name: platform-pkg-${{ matrix.platform }}
          path: packages/@pproenca-node-webcodecs-${{ matrix.platform }}.tar
          retention-days: 14 # Extended for release timing flexibility
          compression-level: 0

      - name: Attest platform package
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: packages/@pproenca/node-webcodecs-${{ matrix.platform }}/bin/node.napi.node

  # ============================================================================
  # Test Node version compatibility using prebuilt binaries
  # Binary is built and tested with Node 22 in build-native
  # Here we verify the same binary works with Node 20/24 (fast compatibility check)
  # ============================================================================
  test-matrix:
    permissions:
      contents: read
    needs: [build-native]
    name: "test-node-${{ matrix.node }}-${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux - Node 20/24 (Node 22 already tested in build-native)
          - { os: ubuntu-24.04, platform: linux-x64, node: "20" }
          - { os: ubuntu-24.04, platform: linux-x64, node: "24" }
          # macOS Intel - Node 20/24
          - { os: macos-15-intel, platform: darwin-x64, node: "20" }
          - { os: macos-15-intel, platform: darwin-x64, node: "24" }
          # macOS ARM - Node 20/24
          - { os: macos-15, platform: darwin-arm64, node: "20" }
          - { os: macos-15, platform: darwin-arm64, node: "24" }

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Download prebuilt artifact
        uses: actions/download-artifact@v6
        with:
          name: platform-pkg-${{ matrix.platform }}

      - name: Extract prebuilt binary
        run: npx tsx scripts/ci/ci-workflow.ts extract-prebuilt --platform "${{ matrix.platform }}" --out packages --prebuilds prebuilds

      - name: Build TypeScript
        run: npm run build:ts

      - name: Test (fast compatibility check)
        run: npm run test:fast
